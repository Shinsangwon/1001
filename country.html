<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë‚˜ë¼-ìˆ˜ë„ ë§ì¶”ê¸° ê²Œì„</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background:#f0f8ff; }
    #game, #result, #feedback { display: none; }
    .flag { width: 120px; margin: 10px auto; }
    .option { display:block; margin:8px auto; padding:10px 20px; border:1px solid #333; border-radius:8px; cursor:pointer; width:200px; background:#fff; }
    .option:hover { background:#e0f7fa; }
    #leaderboard { margin-top:20px; }
    table { border-collapse: collapse; margin:0 auto; }
    th, td { border:1px solid #555; padding:8px 12px; }
    #feedback { margin-top:20px; font-size:1.2em; }
    #nextBtn { margin-top:15px; padding:8px 16px; }
  </style>
</head>
<body>
  <h1>ë‚˜ë¼-ìˆ˜ë„ ë§ì¶”ê¸° ê²Œì„0.5</h1>

  <!-- ì°¸ê°€ì ì„ íƒ -->
  <div id="player-select">
    <h3>í”Œë ˆì´ì–´ ì„ íƒ</h3>
    <select id="presetPlayer">
      <option value="">ì§ì ‘ ì…ë ¥</option>
      <option>ì‹ ì¤€ì—´</option>
      <option>ì‹ ê·œì—´</option>
      <option>íŒŒë‹¥ì´</option>
      <option>ìˆ˜ë°•ì´</option>
    </select>
    <input type="text" id="customPlayer" placeholder="ì´ë¦„ ì…ë ¥">
    <button onclick="startGame()">ì‹œì‘</button>
  </div>

  <!-- ê²Œì„ ì˜ì—­ -->
  <div id="game">
    <h3 id="qnum"></h3>
    <img id="flag" class="flag">
    <h2 id="question"></h2>
    <div id="options"></div>
  </div>

  <!-- ì •ë‹µ í”¼ë“œë°± -->
  <div id="feedback">
    <p id="feedbackMsg"></p>
    <button id="nextBtn" onclick="nextQuestion()">ë‹¤ìŒ ë¬¸ì œ</button>
  </div>

  <!-- ê²°ê³¼ -->
  <div id="result">
    <h2 id="finalMsg"></h2>
    <div id="leaderboard"></div>
  </div>

  <script>
    let countries = [];
    let currentQuestion = 0;
    let score = 0;
    let selectedPlayer = "";
    let startTime;
    let leaderboard = JSON.parse(localStorage.getItem("leaderboard") || "[]");
    let currentAnswer = "";

    // JSON ë¶ˆëŸ¬ì˜¤ê¸°
    fetch("./countries.json")
      .then(res => {
        if (!res.ok) throw new Error("HTTP ìƒíƒœ " + res.status);
        return res.json();
      })
      .then(data => {
        countries = data;
        console.log("ë¡œë“œ ì„±ê³µ:", countries.length, "ê°œ êµ­ê°€");
      })
      .catch(err => console.error("ë¡œë“œ ì‹¤íŒ¨:", err));

    // ì°¸ê°€ì ì„ íƒ í›„ ì‹œì‘
    function startGame() {
      let preset = document.getElementById("presetPlayer").value;
      let custom = document.getElementById("customPlayer").value.trim();
      selectedPlayer = preset || custom;
      if (!selectedPlayer) {
        alert("í”Œë ˆì´ì–´ ì´ë¦„ì„ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•˜ì„¸ìš”!");
        return;
      }

      document.getElementById("player-select").style.display = "none";
      document.getElementById("game").style.display = "block";

      score = 0;
      currentQuestion = 0;
      startTime = new Date();
      nextQuestion();
    }

    // ë¬¸ì œ ì¶œì œ
    function nextQuestion() {
      document.getElementById("feedback").style.display = "none";

      if (currentQuestion >= 10) {
        endGame();
        return;
      }
      currentQuestion++;

      let q = countries[Math.floor(Math.random() * countries.length)];
      currentAnswer = q.capital_ko;

      let options = [q.capital_ko];
      while (options.length < 5) {
        let opt = countries[Math.floor(Math.random() * countries.length)].capital_ko;
        if (!options.includes(opt) && opt) options.push(opt);
      }
      options = options.sort(() => Math.random() - 0.5);

      document.getElementById("qnum").innerText = `ë¬¸ì œ ${currentQuestion}/10`;
      document.getElementById("flag").src = q.flag;
      document.getElementById("question").innerText = `${q.country_ko}ì˜ ìˆ˜ë„ëŠ”?`;

      let optionsDiv = document.getElementById("options");
      optionsDiv.innerHTML = "";
      options.forEach(opt => {
        let btn = document.createElement("button");
        btn.className = "option";
        btn.innerText = opt;
        btn.onclick = () => checkAnswer(opt);
        optionsDiv.appendChild(btn);
      });
    }

    // ì •ë‹µ í™•ì¸
    function checkAnswer(selected) {
      document.getElementById("game").style.display = "none";
      document.getElementById("feedback").style.display = "block";

      if (selected === currentAnswer) {
        score++;
        document.getElementById("feedbackMsg").innerText = `âœ… ì •ë‹µì…ë‹ˆë‹¤! (${currentAnswer})`;
      } else {
        document.getElementById("feedbackMsg").innerText = `âŒ ì˜¤ë‹µì…ë‹ˆë‹¤. ì •ë‹µì€ "${currentAnswer}" ì…ë‹ˆë‹¤.`;
      }
    }

    // ê²Œì„ ì¢…ë£Œ
    function endGame() {
      document.getElementById("game").style.display = "none";
      document.getElementById("feedback").style.display = "none";
      document.getElementById("result").style.display = "block";

      let timeTaken = (new Date() - startTime) / 1000;
      let accuracy = Math.round((score / 10) * 100);

      leaderboard.push({
        name: selectedPlayer,
        score: score,
        accuracy: accuracy,
        time: timeTaken
      });

      leaderboard.sort((a, b) => b.accuracy - a.accuracy || a.time - b.time);
      leaderboard = leaderboard.slice(0, 10);

      localStorage.setItem("leaderboard", JSON.stringify(leaderboard));

      let rank = leaderboard.findIndex(p => p.name === selectedPlayer && p.score === score && p.time === timeTaken) + 1;
      let msg = rank > 0 && rank <= 10
        ? `ì¶•í•˜í•©ë‹ˆë‹¤! ${rank}ìœ„ì…ë‹ˆë‹¤!!`
        : "ì•„ì‰½ë„¤ìš”... ë¶„ë°œí•˜ì„¸ìš”!!";

      document.getElementById("finalMsg").innerText =
        `${selectedPlayer}ë‹˜ì˜ ì ìˆ˜: ${score}/10 (${accuracy}%), ì‹œê°„: ${timeTaken.toFixed(1)}ì´ˆ\n${msg}`;

      renderLeaderboard();
    }

    // ìˆœìœ„í‘œ ì¶œë ¥
    function renderLeaderboard() {
      let html = "<h3>ğŸ† ìˆœìœ„í‘œ (Top 10)</h3><table><tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ì •ë‹µìˆ˜</th><th>ì •ë‹µë¥ </th><th>ì‹œê°„(ì´ˆ)</th></tr>";
      leaderboard.forEach((p, i) => {
        html += `<tr><td>${i + 1}</td><td>${p.name}</td><td>${p.score}/10</td><td>${p.accuracy}%</td><td>${p.time.toFixed(1)}</td></tr>`;
      });
      html += "</table>";
      document.getElementById("leaderboard").innerHTML = html;
    }
  </script>
</body>
</html>
