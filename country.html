<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>나라 수도 국기 게임1.6</title>
  <style>
    body{
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom,#fceabb,#f8b500);
      margin:0; padding:0;
      min-height:100vh; display:flex; justify-content:center; align-items:center;
    }
    #app{ width:100%; max-width:500px; padding:20px; }
    .card{
      background:#fff; border-radius:15px; padding:20px; margin:10px 0;
      box-shadow:0 4px 10px rgba(0,0,0,.1); text-align:center;
    }
    h1,h2,h3{ margin:10px 0; color:#333; }
    .option-btn{
      display:block; width:100%; margin:8px 0; padding:12px;
      font-size:16px; border:none; border-radius:8px; background:#f8b500; color:#fff; cursor:pointer;
    }
    .half-btn{
      display:inline-block; width:48%; margin:4px 1%; padding:10px;
      font-size:14px; border:none; border-radius:8px; background:#f8b500; color:#fff; cursor:pointer;
    }
    .nav-btn{
      display:inline-block; margin:10px 5px; padding:8px 16px;
      font-size:14px; border:none; border-radius:8px; background:#6c757d; color:#fff; cursor:pointer;
    }
    .small-btn{
      display:inline-block; margin:5px; padding:6px 12px;
      font-size:12px; border:none; border-radius:6px; background:#007bff; color:#fff; cursor:pointer;
    }
    img.flag{
      width:150px; border:1px solid #ccc; margin:10px 0; border-radius:8px;
    }
    .wrong-flag{ position:relative; display:inline-block; }
    .wrong-flag::after{
      content:"✖"; position:absolute; top:0; left:0; width:100%; height:100%;
      font-size:60px; color:red; display:flex; align-items:center; justify-content:center;
    }
    table{ width:100%; border-collapse:collapse; margin-top:10px; }
    th,td{ border:1px solid #ddd; padding:6px; font-size:14px; }
    th{ background:#f8b500; color:#fff; }
    input[type="text"]{ padding:8px; width:90%; margin:10px 0; }
    #timer{ font-weight:bold; color:#d9534f; }
  </style>
</head>
<body>
  <div id="app"></div>

  <!-- 효과음 -->
  <audio id="correctSound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3"></audio>
  <audio id="wrongSound" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-950.mp3"></audio>

  <script>
    // 전역 상태
    let countries = [];
    let currentGame = null;
    let currentPlayer = "";
    let score = 0;
    let questionIndex = 0;
    let questions = [];
    let startTime = null;
    let timer = null;
    let timeLeft = 0;
    const QUESTION_TIME = 15;

    // 데이터 로드
    async function loadData(){
      try{
        const res = await fetch("https://shinsangwon.github.io/1001/countries.json",{cache:"no-cache"});
        if(!res.ok) throw new Error("countries.json 로드 실패");
        countries = await res.json();
        showHome();
      }catch(e){
        document.getElementById("app").innerHTML =
          `<div class="card"><h2>데이터 로드 오류</h2><p>${e.message}</p></div>`;
      }
    }

    // 홈
    function showHome(){
      const app = document.getElementById("app");
      app.innerHTML = `
        <div class="card">
          <h1>나라 수도 국기 게임</h1>
          <p>이름을 선택/입력하고 게임을 시작하세요 (각각 5문제)</p>

          <h3>참가자 선택</h3>
          <button class="half-btn" onclick="setPlayer('신준열')">신준열</button>
          <button class="half-btn" onclick="setPlayer('신규열')">신규열</button>
          <button class="half-btn" onclick="setPlayer('파닥이')">파닥이</button>
          <button class="half-btn" onclick="setPlayer('수박이')">수박이</button>
          <input id="playerName" type="text" placeholder="직접 입력"/>
          <button class="nav-btn" onclick="customPlayerSelect()">참가자 등록</button>
          <p id="currentPlayer" style="margin:6px 0; color:#333;"></p>

          <h3>게임 선택</h3>
          <button class="option-btn" onclick="startGame(1)">1. 나라 → 수도 맞추기</button>
          <button class="option-btn" onclick="startGame(2)">2. 수도 → 나라 맞추기</button>
          <button class="option-btn" onclick="startGame(3)">3. 국기 → 나라 맞추기</button>
          <button class="option-btn" onclick="startGame(4)">4. 나라 → 국기 맞추기</button>
          <button class="option-btn" onclick="showStudy()">5. 나라-수도-국기 공부</button>

          <button class="small-btn" onclick="showLeaderboardMenu()">순위 확인</button>
        </div>
      `;
      updateCurrentPlayerLabel();
    }

    function updateCurrentPlayerLabel(){
      const el = document.getElementById("currentPlayer");
      if(!el) return;
      el.textContent = currentPlayer ? `현재 참가자: ${currentPlayer}` : `현재 참가자: (미선택)`;
    }
    function setPlayer(name){ currentPlayer = name; updateCurrentPlayerLabel(); }
    function customPlayerSelect(){
      const name = document.getElementById("playerName").value.trim();
      if(name){ currentPlayer = name; updateCurrentPlayerLabel(); }
    }

    // 게임 시작
    function startGame(gameType){
      if(!currentPlayer){
        alert("참가자를 먼저 선택하거나 입력하세요!");
        return;
      }
      currentGame = gameType;
      score = 0;
      questionIndex = 0;
      startTime = Date.now();
      generateQuestions();
      showQuestion();
    }

    // 문제 생성
    function generateQuestions(){
      questions = [];
      const pool = [...countries];
      for(let i=0; i<5; i++){
        const ans = pool.splice(Math.floor(Math.random()*pool.length),1)[0];
        const opts = [ans];
        while(opts.length < 5){
          const cand = countries[Math.floor(Math.random()*countries.length)];
          if(!opts.includes(cand)) opts.push(cand);
        }
        opts.sort(()=>Math.random()-.5);
        questions.push({ answer: ans, options: opts });
      }
    }

    // 문제 표시
    function showQuestion(){
      const app = document.getElementById("app");
      const q = questions[questionIndex];
      timeLeft = QUESTION_TIME;

      let html = `<div class="card"><h3>${questionIndex+1} / 5</h3>`;
      html += `<p id="timer">남은 시간: ${timeLeft}초</p>`;

      if(currentGame===1){
        html += `<h3>${q.answer.continent_ko}에 있는 ${q.answer.country_ko}의 수도는?</h3>`;
        html += `<img class="flag" src="${q.answer.flag}" alt="flag">`;
        q.options.forEach(o=>{
          html += `<button class="option-btn" onclick="checkAnswer('${escapeQuote(o.capital_ko)}')">${o.capital_ko}</button>`;
        });
      }else if(currentGame===2){
        html += `<h3>${q.answer.capital_ko}의 수도를 가진 나라는 어디일까요? (${q.answer.continent_ko})</h3>`;
        q.options.forEach(o=>{
          html += `<button class="option-btn" onclick="checkAnswer('${escapeQuote(o.country_ko)}')">${o.country_ko}</button>`;
        });
      }else if(currentGame===3){
        html += `<h3>다음 국기는 어느 나라 국기일까요? (${q.answer.continent_ko})</h3>`;
        html += `<img class="flag" src="${q.answer.flag}" alt="flag">`;
        q.options.forEach(o=>{
          html += `<button class="option-btn" onclick="checkAnswer('${escapeQuote(o.country_ko)}')">${o.country_ko}</button>`;
        });
      }else if(currentGame===4){
        html += `<h3>${q.answer.continent_ko}에 있는 ${q.answer.country_ko}의 국기는?</h3>`;
        q.options.forEach(o=>{
          html += `<button class="option-btn" onclick="checkAnswer('${escapeQuote(o.country_ko)}')"><img class="flag" src="${o.flag}" alt="flag"></button>`;
        });
      }
      html += `</div>`;
      app.innerHTML = html;

      startTimer();
    }

    function startTimer(){
      clearInterval(timer);
      timer = setInterval(()=>{
        timeLeft--;
        const el = document.getElementById("timer");
        if(el) el.textContent = `남은 시간: ${timeLeft}초`;
        if(timeLeft <= 0){
          clearInterval(timer);
          checkAnswer("TIMEOUT");
        }
      },1000);
    }

    function escapeQuote(str){
      return String(str).replaceAll("'", "\\'");
    }

    // 정답 확인
    function checkAnswer(choice){
      clearInterval(timer);
      const q = questions[questionIndex];
      const app = document.getElementById("app");
      let html = `<div class="card"><h3>${questionIndex+1} / 5</h3>`;

      const isCorrect =
        (currentGame===1 && choice===q.answer.capital_ko) ||
        (currentGame===2 && choice===q.answer.country_ko) ||
        (currentGame===3 && choice===q.answer.country_ko) ||
        (currentGame===4 && choice===q.answer.country_ko);

      if(isCorrect){
        score++;
        document.getElementById("correctSound").play();
        html += `<p><b>정답!</b></p>`;
      }else{
        document.getElementById("wrongSound").play();
        if(choice==="TIMEOUT"){
          html += `<p><b>시간 초과!</b> 정답은 <b>${q.answer.country_ko} / ${q.answer.capital_ko}</b></p>`;
        }else if(currentGame===1){
          html += `<p>오답! 정답은 <b>${q.answer.capital_ko}</b></p>`;
        }else if(currentGame===2){
          html += `<p>오답! 정답은 <b>${q.answer.country_ko}</b></p>`;
        }else if(currentGame===3){
          const wrongFlag = (countries.find(c=>c.country_ko===choice)||{}).flag || "";
          html += `
            <img class="flag" src="${q.answer.flag}" alt="correct-flag"><br/>
            <p>오답! 정답은 <b>${q.answer.country_ko}</b>입니다.</p>
            <p>선택한 답(<b>${choice}</b>)의 국기는 아래와 같습니다.</p>
            ${wrongFlag ? `<img class="flag" src="${wrongFlag}" alt="wrong-flag">` : ``}
          `;
        }else if(currentGame===4){
          const wrong = countries.find(c=>c.country_ko===choice);
          html += `
            <p>선택하신 국기는 <b>${choice}</b>의 국기입니다.</p>
            ${wrong ? `<div class="wrong-flag"><img class="flag" src="${wrong.flag}" alt="wrong-flag"></div>` : ``}
            <p>정답은 <b>${q.answer.country_ko}</b>의 국기입니다.</p>
            <img class="flag" src="${q.answer.flag}" alt="correct-flag">
          `;
        }
      }

      questionIndex++;
      if(questionIndex < 5){
        html += `<button class="nav-btn" onclick="showQuestion()">다음 문제</button>`;
      }else{
        saveScore();
        html += `<button class="nav-btn" onclick="showResult()">결과 확인</button>`;
      }
      html += `<button class="nav-btn" onclick="showHome()">처음으로</button>`;
      html += `</div>`;
      app.innerHTML = html;
    }

    // 결과 + 순위 저장
    function saveScore(){
      const elapsed = Math.floor((Date.now()-startTime)/1000);
      const storeKey = "leaderboard";
      const data = JSON.parse(localStorage.getItem(storeKey) || "{}");
      if(!data[currentGame]) data[currentGame] = [];
      data[currentGame].push({ player: currentPlayer, score, time: elapsed, ts: Date.now() });
      data[currentGame].sort((a,b)=> (b.score-a.score) || (a.time-b.time) || (a.ts-b.ts));
      data[currentGame] = data[currentGame].slice(0,10);
      localStorage.setItem(storeKey, JSON.stringify(data));
    }

    function showResult(){
      const elapsed = Math.floor((Date.now()-startTime)/1000);
      const { rankText, tableHTML } = buildRankingSummary(currentGame, currentPlayer, score, elapsed);
      document.getElementById("app").innerHTML = `
        <div class="card">
          <h2>게임 종료</h2>
          <p>${currentPlayer}님 점수: <b>${score}/5</b></p>
          <p>소요시간: <b>${elapsed}초</b></p>
          <p>${rankText}</p>
          ${tableHTML}
          <button class="nav-btn" onclick="showHome()">처음으로</button>
          <button class="nav-btn" onclick="showLeaderboardMenu()">순위 확인</button>
        </div>
      `;
    }

    function buildRankingSummary(gameType, player, sc, tm){
      const data = JSON.parse(localStorage.getItem("leaderboard") || "{}");
      const list = data[gameType] || [];
      let idx = -1;
      for(let i=0;i<list.length;i++){
        const e = list[i];
        if(e.player===player && e.score===sc && e.time===tm){ idx = i; break; }
      }
      const rankText = (idx>-1 && idx<10) ? `축하합니다! ${idx+1}위입니다!! 🎉` : `아쉽네요... 분발하세요!!`;

      let rows = list.map((e,i)=>`<tr><td>${i+1}</td><td>${e.player}</td><td>${e.score}</td><td>${e.time}초</td></tr>`).join("");
      const tableHTML = `
        <h3>순위표 (게임 ${gameType})</h3>
        <table>
          <tr><th>순위</th><th>이름</th><th>점수</th><th>시간(초)</th></tr>
          ${rows}
        </table>
      `;
      return { rankText, tableHTML };
    }

    function showLeaderboardMenu(){
      document.getElementById("app").innerHTML = `
        <div class="card">
          <h2>순위 확인</h2>
          <button class="option-btn" onclick="showLeaderboard(1)">1. 나라 → 수도</button>
          <button class="option-btn" onclick="showLeaderboard(2)">2. 수도 → 나라</button>
          <button class="option-btn" onclick="showLeaderboard(3)">3. 국기 → 나라</button>
          <button class="option-btn" onclick="showLeaderboard(4)">4. 나라 → 국기</button>
          <button class="nav-btn" onclick="showHome()">처음으로</button>
        </div>
      `;
    }

    function showLeaderboard(gameType){
      const data = JSON.parse(localStorage.getItem("leaderboard") || "{}");
      const list = data[gameType] || [];
      let rows = list.map((e,i)=>`<tr><td>${i+1}</td><td>${e.player}</td><td>${e.score}</td><td>${e.time}초</td></tr>`).join("");
      document.getElementById("app").innerHTML = `
        <div class="card">
          <h2>게임 ${gameType} 순위</h2>
          <table>
            <tr><th>순위</th><th>이름</th><th>점수</th><th>시간(초)</th></tr>
            ${rows}
          </table>
          <button class="nav-btn" onclick="showLeaderboardMenu()">뒤로</button>
        </div>
      `;
    }

    // 공부 모드
    function showStudy(filter="전체"){
      let filtered = countries;
      if(filter !== "전체"){ filtered = countries.filter(c=>c.continent_ko===filter); }
      const rows = [...filtered]
        .sort((a,b)=> a.continent_ko.localeCompare(b.continent_ko,"ko") || a.country_ko.localeCompare(b.country_ko,"ko"))
        .map(c=>`
          <tr>
            <td>${c.continent_ko}</td>
            <td><img src="${c.flag}" alt="flag" width="40"></td>
            <td>${c.country_ko}</td>
            <td>${c.capital_ko || ""}</td>
          </tr>`).join("");

      document.getElementById("app").innerHTML = `
        <div class="card">
          <h2>나라-수도-국기 공부</h2>
