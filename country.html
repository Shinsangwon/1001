<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>나라-수도 맞추기 게임</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background:#f0f8ff; }
    #game, #result, #feedback { display: none; }
    .flag { width: 120px; margin: 10px auto; }
    .option { display:block; margin:8px auto; padding:10px 20px; border:1px solid #333; border-radius:8px; cursor:pointer; width:200px; background:#fff; }
    .option:hover { background:#e0f7fa; }
    #leaderboard { margin-top:20px; }
    table { border-collapse: collapse; margin:0 auto; }
    th, td { border:1px solid #555; padding:8px 12px; }
    #feedback { margin-top:20px; font-size:1.2em; }
    #nextBtn { margin-top:15px; padding:8px 16px; }
  </style>
</head>
<body>
  <h1>나라-수도 맞추기 게임0.5</h1>

  <!-- 참가자 선택 -->
  <div id="player-select">
    <h3>플레이어 선택</h3>
    <select id="presetPlayer">
      <option value="">직접 입력</option>
      <option>신준열</option>
      <option>신규열</option>
      <option>파닥이</option>
      <option>수박이</option>
    </select>
    <input type="text" id="customPlayer" placeholder="이름 입력">
    <button onclick="startGame()">시작</button>
  </div>

  <!-- 게임 영역 -->
  <div id="game">
    <h3 id="qnum"></h3>
    <img id="flag" class="flag">
    <h2 id="question"></h2>
    <div id="options"></div>
  </div>

  <!-- 정답 피드백 -->
  <div id="feedback">
    <p id="feedbackMsg"></p>
    <button id="nextBtn" onclick="nextQuestion()">다음 문제</button>
  </div>

  <!-- 결과 -->
  <div id="result">
    <h2 id="finalMsg"></h2>
    <div id="leaderboard"></div>
  </div>

  <script>
    let countries = [];
    let currentQuestion = 0;
    let score = 0;
    let selectedPlayer = "";
    let startTime;
    let leaderboard = JSON.parse(localStorage.getItem("leaderboard") || "[]");
    let currentAnswer = "";

    // JSON 불러오기
    fetch("./countries.json")
      .then(res => {
        if (!res.ok) throw new Error("HTTP 상태 " + res.status);
        return res.json();
      })
      .then(data => {
        countries = data;
        console.log("로드 성공:", countries.length, "개 국가");
      })
      .catch(err => console.error("로드 실패:", err));

    // 참가자 선택 후 시작
    function startGame() {
      let preset = document.getElementById("presetPlayer").value;
      let custom = document.getElementById("customPlayer").value.trim();
      selectedPlayer = preset || custom;
      if (!selectedPlayer) {
        alert("플레이어 이름을 선택하거나 입력하세요!");
        return;
      }

      document.getElementById("player-select").style.display = "none";
      document.getElementById("game").style.display = "block";

      score = 0;
      currentQuestion = 0;
      startTime = new Date();
      nextQuestion();
    }

    // 문제 출제
    function nextQuestion() {
      document.getElementById("feedback").style.display = "none";

      if (currentQuestion >= 10) {
        endGame();
        return;
      }
      currentQuestion++;

      let q = countries[Math.floor(Math.random() * countries.length)];
      currentAnswer = q.capital_ko;

      let options = [q.capital_ko];
      while (options.length < 5) {
        let opt = countries[Math.floor(Math.random() * countries.length)].capital_ko;
        if (!options.includes(opt) && opt) options.push(opt);
      }
      options = options.sort(() => Math.random() - 0.5);

      document.getElementById("qnum").innerText = `문제 ${currentQuestion}/10`;
      document.getElementById("flag").src = q.flag;
      document.getElementById("question").innerText = `${q.country_ko}의 수도는?`;

      let optionsDiv = document.getElementById("options");
      optionsDiv.innerHTML = "";
      options.forEach(opt => {
        let btn = document.createElement("button");
        btn.className = "option";
        btn.innerText = opt;
        btn.onclick = () => checkAnswer(opt);
        optionsDiv.appendChild(btn);
      });
    }

    // 정답 확인
    function checkAnswer(selected) {
      document.getElementById("game").style.display = "none";
      document.getElementById("feedback").style.display = "block";

      if (selected === currentAnswer) {
        score++;
        document.getElementById("feedbackMsg").innerText = `✅ 정답입니다! (${currentAnswer})`;
      } else {
        document.getElementById("feedbackMsg").innerText = `❌ 오답입니다. 정답은 "${currentAnswer}" 입니다.`;
      }
    }

    // 게임 종료
    function endGame() {
      document.getElementById("game").style.display = "none";
      document.getElementById("feedback").style.display = "none";
      document.getElementById("result").style.display = "block";

      let timeTaken = (new Date() - startTime) / 1000;
      let accuracy = Math.round((score / 10) * 100);

      leaderboard.push({
        name: selectedPlayer,
        score: score,
        accuracy: accuracy,
        time: timeTaken
      });

      leaderboard.sort((a, b) => b.accuracy - a.accuracy || a.time - b.time);
      leaderboard = leaderboard.slice(0, 10);

      localStorage.setItem("leaderboard", JSON.stringify(leaderboard));

      let rank = leaderboard.findIndex(p => p.name === selectedPlayer && p.score === score && p.time === timeTaken) + 1;
      let msg = rank > 0 && rank <= 10
        ? `축하합니다! ${rank}위입니다!!`
        : "아쉽네요... 분발하세요!!";

      document.getElementById("finalMsg").innerText =
        `${selectedPlayer}님의 점수: ${score}/10 (${accuracy}%), 시간: ${timeTaken.toFixed(1)}초\n${msg}`;

      renderLeaderboard();
    }

    // 순위표 출력
    function renderLeaderboard() {
      let html = "<h3>🏆 순위표 (Top 10)</h3><table><tr><th>순위</th><th>이름</th><th>정답수</th><th>정답률</th><th>시간(초)</th></tr>";
      leaderboard.forEach((p, i) => {
        html += `<tr><td>${i + 1}</td><td>${p.name}</td><td>${p.score}/10</td><td>${p.accuracy}%</td><td>${p.time.toFixed(1)}</td></tr>`;
      });
      html += "</table>";
      document.getElementById("leaderboard").innerHTML = html;
    }
  </script>
</body>
</html>
