<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>나라 맞추기 게임</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #fefaf6;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    h1 {
      color: #444;
      margin-top: 20px;
    }
    .container {
      padding: 15px;
    }
    button {
      background-color: #ffcccb;
      border: none;
      border-radius: 10px;
      padding: 12px 20px;
      margin: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: 0.3s;
      width: 80%;
      max-width: 280px;
    }
    button:hover {
      background-color: #ffb6c1;
    }
    .flag-img {
      width: 120px;
      height: auto;
      margin: 10px;
    }
    .game-area {
      margin-top: 20px;
    }
    .hidden {
      display: none;
    }
    .study-table {
      width: 95%;
      max-width: 800px;
      margin: 15px auto;
      border-collapse: collapse;
      background-color: #fff;
    }
    .study-table th, .study-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    .study-table th {
      background-color: #ffe4e1;
    }
    .question-count {
      font-weight: bold;
      margin: 10px;
    }
    .back-btn {
      margin-top: 20px;
      background-color: #add8e6;
    }
  </style>
</head>
<body>
  <h1>🌏 나라 맞추기 게임1.3</h1>
  <div class="container" id="menu">
    <p>모든 게임은 10문제가 출제됩니다.<br>오답 시 정답을 알려주고, 버튼을 눌러 다음 문제로 넘어갑니다.</p>
    <button onclick="startGame(1)">1. 나라 이름 → 수도 맞추기</button>
    <button onclick="startGame(2)">2. 수도 이름 → 나라 맞추기</button>
    <button onclick="startGame(3)">3. 국기 → 나라 맞추기</button>
    <button onclick="startGame(4)">4. 나라 이름 → 국기 맞추기</button>
    <button onclick="showStudy()">5. 나라-수도-국기 공부</button>
  </div>

  <div class="container game-area hidden" id="gameArea">
    <div id="questionCount" class="question-count"></div>
    <div id="question"></div>
    <img id="flag" class="flag-img hidden">
    <div id="options"></div>
    <div id="feedback"></div>
    <button id="nextBtn" class="hidden" onclick="nextQuestion()">다음 문제</button>
    <button class="back-btn" onclick="goHome()">⬅ 초기 화면</button>
  </div>

  <div class="container hidden" id="studyArea">
    <h2>나라-수도-국기 공부</h2>
    <div id="continentFilters"></div>
    <table class="study-table" id="studyTable">
      <thead>
        <tr>
          <th>대륙</th>
          <th>국기</th>
          <th>나라</th>
          <th>수도</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="back-btn" onclick="goHome()">⬅ 초기 화면</button>
  </div>

  <script>
    let countries = [];
    let currentGame = 0;
    let currentQuestion = 0;
    let score = 0;
    let selectedQuestions = [];
    let startTime;

    async function loadCountries() {
      const res = await fetch("https://shinsangwon.github.io/1001/countries.json");
      countries = await res.json();
    }

    function goHome() {
      document.getElementById("menu").classList.remove("hidden");
      document.getElementById("gameArea").classList.add("hidden");
      document.getElementById("studyArea").classList.add("hidden");
      document.getElementById("feedback").innerHTML = "";
      document.getElementById("flag").classList.add("hidden");
      score = 0;
      currentQuestion = 0;
    }

    function startGame(gameType) {
      currentGame = gameType;
      document.getElementById("menu").classList.add("hidden");
      document.getElementById("gameArea").classList.remove("hidden");
      score = 0;
      currentQuestion = 0;
      selectedQuestions = shuffle([...countries]).slice(0, 10);
      startTime = new Date();
      loadQuestion();
    }

    function loadQuestion() {
      document.getElementById("feedback").innerHTML = "";
      document.getElementById("nextBtn").classList.add("hidden");
      document.getElementById("flag").classList.add("hidden");

      if (currentQuestion >= selectedQuestions.length) {
        endGame();
        return;
      }

      const q = selectedQuestions[currentQuestion];
      document.getElementById("questionCount").innerText = `문제 ${currentQuestion + 1} / 10`;
      let options = shuffle([...countries]).slice(0, 4);
      if (!options.some(c => c.country_ko === q.country_ko)) {
        options[0] = q;
      }
      options = shuffle(options);

      let questionText = "";
      if (currentGame === 1) {
        questionText = `(${q.continent_ko}) ${q.country_ko}의 수도는 어디일까요?`;
        document.getElementById("flag").src = q.flag;
        document.getElementById("flag").classList.remove("hidden");
        renderOptions(options.map(c => c.capital_ko), q.capital_ko);
      } else if (currentGame === 2) {
        questionText = `(${q.continent_ko}) ${q.capital_ko}는 어느 나라의 수도일까요?`;
        renderOptions(options.map(c => c.country_ko), q.country_ko);
      } else if (currentGame === 3) {
        questionText = `(${q.continent_ko}) 이 국기는 어느 나라일까요?`;
        document.getElementById("flag").src = q.flag;
        document.getElementById("flag").classList.remove("hidden");
        renderOptions(options.map(c => c.country_ko), q.country_ko);
      } else if (currentGame === 4) {
        questionText = `(${q.continent_ko}) ${q.country_ko}의 국기는 무엇일까요?`;
        renderOptions(options.map(c => c.flag), q.flag, true);
      }

      document.getElementById("question").innerText = questionText;
    }

    function renderOptions(optionList, correctAnswer, isFlag = false) {
      const container = document.getElementById("options");
      container.innerHTML = "";
      optionList.forEach(opt => {
        const btn = document.createElement("button");
        if (isFlag) {
          btn.innerHTML = `<img src="${opt}" class="flag-img">`;
        } else {
          btn.textContent = opt;
        }
        btn.onclick = () => checkAnswer(opt, correctAnswer, isFlag);
        container.appendChild(btn);
      });
    }

    function checkAnswer(selected, correct, isFlag = false) {
      let feedback = "";
      if (selected === correct) {
        feedback = "정답입니다! 🎉";
        score++;
      } else {
        feedback = `오답입니다! 정답은 ${isFlag ? "" : correct} 입니다.`;
        if (isFlag) {
          feedback += `<br><img src="${correct}" class="flag-img">`;
        }
      }
      document.getElementById("feedback").innerHTML = feedback;
      document.getElementById("nextBtn").classList.remove("hidden");
    }

    function nextQuestion() {
      currentQuestion++;
      loadQuestion();
    }

    function endGame() {
      const endTime = new Date();
      const duration = ((endTime - startTime) / 1000).toFixed(1);
      document.getElementById("question").innerHTML =
        `게임 종료!<br>정답 개수: ${score}/10<br>풀이 시간: ${duration}초`;
      document.getElementById("options").innerHTML = "";
      document.getElementById("flag").classList.add("hidden");
      document.getElementById("questionCount").innerText = "";
      document.getElementById("nextBtn").classList.add("hidden");
    }

    function showStudy() {
      document.getElementById("menu").classList.add("hidden");
      document.getElementById("studyArea").classList.remove("hidden");
      renderStudyTable("전체");
      renderContinentFilters();
    }

    function renderContinentFilters() {
      const container = document.getElementById("continentFilters");
      const continents = [...new Set(countries.map(c => c.continent_ko))];
      container.innerHTML = `<button onclick="renderStudyTable('전체')">전체</button>`;
      continents.forEach(cont => {
        container.innerHTML += `<button onclick="renderStudyTable('${cont}')">${cont}</button>`;
      });
    }

    function renderStudyTable(filter) {
      const tbody = document.querySelector("#studyTable tbody");
      tbody.innerHTML = "";
      let filtered = filter === "전체" ? countries : countries.filter(c => c.continent_ko === filter);
      filtered.sort((a, b) => {
        if (a.continent_ko === b.continent_ko) {
          return a.country_ko.localeCompare(b.country_ko);
        }
        return a.continent_ko.localeCompare(b.continent_ko);
      });
      filtered.forEach(c => {
        const row = `<tr>
          <td>${c.continent_ko}</td>
          <td><img src="${c.flag}" class="flag-img"></td>
          <td>${c.country_ko}</td>
          <td>${c.capital_ko || "-"}</td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    function shuffle(array) {
      return array.sort(() => Math.random() - 0.5);
    }

    loadCountries();
  </script>
</body>
</html>
