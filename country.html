<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë‚˜ë¼ ìˆ˜ë„ êµ­ê¸° ê²Œì„1.5</title>
  <style>
    body{
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom,#fceabb,#f8b500);
      margin:0; padding:0;
      min-height:100vh; display:flex; justify-content:center; align-items:center;
    }
    #app{ width:100%; max-width:500px; padding:20px; }
    .card{
      background:#fff; border-radius:15px; padding:20px; margin:10px 0;
      box-shadow:0 4px 10px rgba(0,0,0,.1); text-align:center;
    }
    h1,h2,h3{ margin:10px 0; color:#333; }
    .option-btn{
      display:block; width:100%; margin:8px 0; padding:12px;
      font-size:16px; border:none; border-radius:8px; background:#f8b500; color:#fff; cursor:pointer;
    }
    .half-btn{
      display:inline-block; width:48%; margin:4px 1%; padding:10px;
      font-size:14px; border:none; border-radius:8px; background:#f8b500; color:#fff; cursor:pointer;
    }
    .nav-btn{
      display:inline-block; margin:10px 5px; padding:8px 16px;
      font-size:14px; border:none; border-radius:8px; background:#6c757d; color:#fff; cursor:pointer;
    }
    .small-btn{
      display:inline-block; margin:5px; padding:6px 12px;
      font-size:12px; border:none; border-radius:6px; background:#007bff; color:#fff; cursor:pointer;
    }
    img.flag{
      width:150px; border:1px solid #ccc; margin:10px 0; border-radius:8px;
    }
    .wrong-flag{ position:relative; display:inline-block; }
    .wrong-flag::after{
      content:"âœ–"; position:absolute; top:0; left:0; width:100%; height:100%;
      font-size:60px; color:red; display:flex; align-items:center; justify-content:center;
    }
    table{ width:100%; border-collapse:collapse; margin-top:10px; }
    th,td{ border:1px solid #ddd; padding:6px; font-size:14px; }
    th{ background:#f8b500; color:#fff; }
    input[type="text"]{ padding:8px; width:90%; margin:10px 0; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // ì „ì—­ ìƒíƒœ
    let countries = [];
    let currentGame = null;
    let currentPlayer = "";
    let score = 0;
    let questionIndex = 0;
    let questions = [];
    let startTime = null;

    // ë°ì´í„° ë¡œë“œ
    async function loadData(){
      try{
        const res = await fetch("https://shinsangwon.github.io/1001/countries.json",{cache:"no-cache"});
        if(!res.ok) throw new Error("countries.json ë¡œë“œ ì‹¤íŒ¨");
        countries = await res.json();
        showHome();
      }catch(e){
        document.getElementById("app").innerHTML =
          `<div class="card"><h2>ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜</h2><p>${e.message}</p></div>`;
      }
    }

    // í™ˆ (ì°¸ê°€ì ì„ íƒ + ê²Œì„ ì„ íƒ + ìˆœìœ„ í™•ì¸)
    function showHome(){
      const app = document.getElementById("app");
      app.innerHTML = `
        <div class="card">
          <h1>ë‚˜ë¼ ìˆ˜ë„ êµ­ê¸° ê²Œì„</h1>
          <p>ì´ë¦„ì„ ì„ íƒ/ì…ë ¥í•˜ê³  ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš” (ê°ê° 5ë¬¸ì œ)</p>

          <h3>ì°¸ê°€ì ì„ íƒ</h3>
          <button class="half-btn" onclick="setPlayer('ì‹ ì¤€ì—´')">ì‹ ì¤€ì—´</button>
          <button class="half-btn" onclick="setPlayer('ì‹ ê·œì—´')">ì‹ ê·œì—´</button>
          <button class="half-btn" onclick="setPlayer('íŒŒë‹¥ì´')">íŒŒë‹¥ì´</button>
          <button class="half-btn" onclick="setPlayer('ìˆ˜ë°•ì´')">ìˆ˜ë°•ì´</button>
          <input id="playerName" type="text" placeholder="ì§ì ‘ ì…ë ¥"/>
          <button class="nav-btn" onclick="customPlayerSelect()">ì°¸ê°€ì ë“±ë¡</button>
          <p id="currentPlayer" style="margin:6px 0; color:#333;"></p>

          <h3>ê²Œì„ ì„ íƒ</h3>
          <button class="option-btn" onclick="startGame(1)">1. ë‚˜ë¼ â†’ ìˆ˜ë„ ë§ì¶”ê¸°</button>
          <button class="option-btn" onclick="startGame(2)">2. ìˆ˜ë„ â†’ ë‚˜ë¼ ë§ì¶”ê¸°</button>
          <button class="option-btn" onclick="startGame(3)">3. êµ­ê¸° â†’ ë‚˜ë¼ ë§ì¶”ê¸°</button>
          <button class="option-btn" onclick="startGame(4)">4. ë‚˜ë¼ â†’ êµ­ê¸° ë§ì¶”ê¸°</button>
          <button class="option-btn" onclick="showStudy()">5. ë‚˜ë¼-ìˆ˜ë„-êµ­ê¸° ê³µë¶€</button>

          <button class="small-btn" onclick="showLeaderboardMenu()">ìˆœìœ„ í™•ì¸</button>
        </div>
      `;
      // í˜„ì¬ ì„ íƒëœ ì°¸ê°€ì í‘œì‹œ
      updateCurrentPlayerLabel();
    }

    function updateCurrentPlayerLabel(){
      const el = document.getElementById("currentPlayer");
      if(!el) return;
      el.textContent = currentPlayer ? `í˜„ì¬ ì°¸ê°€ì: ${currentPlayer}` : `í˜„ì¬ ì°¸ê°€ì: (ë¯¸ì„ íƒ)`;
    }

    function setPlayer(name){ currentPlayer = name; updateCurrentPlayerLabel(); }
    function customPlayerSelect(){
      const name = document.getElementById("playerName").value.trim();
      if(name){ currentPlayer = name; updateCurrentPlayerLabel(); }
    }

    // ê²Œì„ ì‹œì‘
    function startGame(gameType){
      if(!currentPlayer){
        alert("ì°¸ê°€ìë¥¼ ë¨¼ì € ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•˜ì„¸ìš”!");
        return;
      }
      currentGame = gameType;
      score = 0;
      questionIndex = 0;
      startTime = Date.now();
      generateQuestions();
      showQuestion();
    }

    // ë¬¸ì œ 5ê°œ ìƒì„± (ê° ë¬¸ì œë§ˆë‹¤ ë³´ê¸° 5ê°œ)
    function generateQuestions(){
      questions = [];
      const pool = [...countries]; // ì–•ì€ ë³µì‚¬
      for(let i=0; i<5; i++){
        // ì •ë‹µ í•˜ë‚˜ ë½‘ê¸°
        const ans = pool.splice(Math.floor(Math.random()*pool.length),1)[0];
        // ë³´ê¸° ê¾¸ë¦¬ê¸° (ì •ë‹µ + ì˜¤ë‹µ)
        const opts = [ans];
        // ì˜¤ë‹µì€ ì „ì²´ countriesì—ì„œ ëœë¤ ì¶”ì¶œ(ì¤‘ë³µ ë°©ì§€)
        while(opts.length < 5){
          const cand = countries[Math.floor(Math.random()*countries.length)];
          if(!opts.includes(cand)) opts.push(cand);
        }
        // ë³´ê¸° ì„ê¸°
        opts.sort(()=>Math.random()-.5);
        questions.push({ answer: ans, options: opts });
      }
    }

    // ë¬¸ì œ í™”ë©´
    function showQuestion(){
      const app = document.getElementById("app");
      const q = questions[questionIndex];

      let html = `<div class="card"><h3>${questionIndex+1} / 5</h3>`;
      if(currentGame===1){
        // ë‚˜ë¼ â†’ ìˆ˜ë„ (êµ­ê¸° ë³´ì—¬ì¤Œ, ëŒ€ë¥™ íŒíŠ¸)
        html += `<h3>${q.answer.continent_ko}ì— ìˆëŠ” ${q.answer.country_ko}ì˜ ìˆ˜ë„ëŠ”?</h3>`;
        html += `<img class="flag" src="${q.answer.flag}" alt="flag">`;
        q.options.forEach(o=>{
          html += `<button class="option-btn" onclick="checkAnswer('${escapeQuote(o.capital_ko)}')">${o.capital_ko}</button>`;
        });
      }else if(currentGame===2){
        // ìˆ˜ë„ â†’ ë‚˜ë¼ (ëŒ€ë¥™ íŒíŠ¸, êµ­ê¸° X)
        html += `<h3>${q.answer.capital_ko}ì˜ ìˆ˜ë„ë¥¼ ê°€ì§„ ë‚˜ë¼ëŠ” ì–´ë””ì¼ê¹Œìš”? (${q.answer.continent_ko})</h3>`;
        q.options.forEach(o=>{
          html += `<button class="option-btn" onclick="checkAnswer('${escapeQuote(o.country_ko)}')">${o.country_ko}</button>`;
        });
      }else if(currentGame===3){
        // êµ­ê¸° â†’ ë‚˜ë¼ (ëŒ€ë¥™ íŒíŠ¸, ì •ë‹µ êµ­ê¸° ë¨¼ì € ë³´ì—¬ì£¼ëŠ” ì˜¤ë‹µí•´ì„¤ í•„ìš”)
        html += `<h3>ë‹¤ìŒ êµ­ê¸°ëŠ” ì–´ëŠ ë‚˜ë¼ êµ­ê¸°ì¼ê¹Œìš”? (${q.answer.continent_ko})</h3>`;
        html += `<img class="flag" src="${q.answer.flag}" alt="flag">`;
        q.options.forEach(o=>{
          html += `<button class="option-btn" onclick="checkAnswer('${escapeQuote(o.country_ko)}')">${o.country_ko}</button>`;
        });
      }else if(currentGame===4){
        // ë‚˜ë¼ â†’ êµ­ê¸° (ë³´ê¸°: êµ­ê¸° ì´ë¯¸ì§€ 5ê°œ)
        html += `<h3>${q.answer.continent_ko}ì— ìˆëŠ” ${q.answer.country_ko}ì˜ êµ­ê¸°ëŠ”?</h3>`;
        q.options.forEach(o=>{
          html += `<button class="option-btn" onclick="checkAnswer('${escapeQuote(o.country_ko)}')"><img class="flag" src="${o.flag}" alt="flag"></button>`;
        });
      }
      html += `</div>`;
      app.innerHTML = html;
    }

    // ë”°ì˜´í‘œ ì´ìŠ¤ì¼€ì´í”„ (onclick ë¬¸ìì—´ ì•ˆì •ì„±)
    function escapeQuote(str){
      return String(str).replaceAll("'", "\\'");
    }

    // ì •ë‹µ í™•ì¸ + í•´ì„¤
    function checkAnswer(choice){
      const q = questions[questionIndex];
      const app = document.getElementById("app");
      let html = `<div class="card"><h3>${questionIndex+1} / 5</h3>`;

      const isCorrect =
        (currentGame===1 && choice===q.answer.capital_ko) ||
        (currentGame===2 && choice===q.answer.country_ko) ||
        (currentGame===3 && choice===q.answer.country_ko) ||
        (currentGame===4 && choice===q.answer.country_ko);

      if(isCorrect){
        score++;
        html += `<p><b>ì •ë‹µ!</b></p>`;
      }else{
        // ì˜¤ë‹µ í•´ì„¤
        if(currentGame===1){
          html += `<p>ì˜¤ë‹µ! ì •ë‹µì€ <b>${q.answer.capital_ko}</b></p>`;
        }else if(currentGame===2){
          html += `<p>ì˜¤ë‹µ! ì •ë‹µì€ <b>${q.answer.country_ko}</b></p>`;
        }else if(currentGame===3){
          // (ìš”ì²­) ë¬¸ì œ êµ­ê¸° ë¨¼ì €, ê·¸ ë‹¤ìŒ ë¬¸êµ¬ + ì„ íƒí•œ ë‚˜ë¼ì˜ êµ­ê¸°
          const wrongFlag = (countries.find(c=>c.country_ko===choice)||{}).flag || "";
          html += `
            <img class="flag" src="${q.answer.flag}" alt="correct-flag"><br/>
            <p>ì˜¤ë‹µ! ì •ë‹µì€ <b>${q.answer.country_ko}</b>ì…ë‹ˆë‹¤.</p>
            <p>ì„ íƒí•œ ë‹µ(<b>${choice}</b>)ì˜ êµ­ê¸°ëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.</p>
            ${wrongFlag ? `<img class="flag" src="${wrongFlag}" alt="wrong-flag">` : ``}
          `;
        }else if(currentGame===4){
          // (ìš”ì²­) ì„ íƒí•œ êµ­ê¸° ì´ë¯¸ì§€ + Xí‘œì‹œ, ì •ë‹µ êµ­ê¸° ì•„ë˜ì—
          const wrong = countries.find(c=>c.country_ko===choice);
          html += `
            <p>ì„ íƒí•˜ì‹  êµ­ê¸°ëŠ” <b>${choice}</b>ì˜ êµ­ê¸°ì…ë‹ˆë‹¤.</p>
            ${wrong ? `<div class="wrong-flag"><img class="flag" src="${wrong.flag}" alt="wrong-flag"></div>` : ``}
            <p>ì •ë‹µì€ <b>${q.answer.country_ko}</b>ì˜ êµ­ê¸°ì…ë‹ˆë‹¤.</p>
            <img class="flag" src="${q.answer.flag}" alt="correct-flag">
          `;
        }
      }

      questionIndex++;
      if(questionIndex < 5){
        html += `<button class="nav-btn" onclick="showQuestion()">ë‹¤ìŒ ë¬¸ì œ</button>`;
      }else{
        saveScore(); // ì €ì¥ í›„ ê²°ê³¼ë¡œ
        html += `<button class="nav-btn" onclick="showResult()">ê²°ê³¼ í™•ì¸</button>`;
      }
      html += `<button class="nav-btn" onclick="showHome()">ì²˜ìŒìœ¼ë¡œ</button>`;
      html += `</div>`;
      app.innerHTML = html;
    }

    // ê²°ê³¼ + ìˆœìœ„ ì €ì¥
    function saveScore(){
      const elapsed = Math.floor((Date.now()-startTime)/1000);
      const storeKey = "leaderboard";
      const data = JSON.parse(localStorage.getItem(storeKey) || "{}");
      if(!data[currentGame]) data[currentGame] = [];
      data[currentGame].push({ player: currentPlayer, score, time: elapsed, ts: Date.now() });
      data[currentGame].sort((a,b)=> (b.score-a.score) || (a.time-b.time) || (a.ts-b.ts));
      data[currentGame] = data[currentGame].slice(0,10);
      localStorage.setItem(storeKey, JSON.stringify(data));
    }

    function showResult(){
      const elapsed = Math.floor((Date.now()-startTime)/1000);
      const { rankText, tableHTML } = buildRankingSummary(currentGame, currentPlayer, score, elapsed);
      document.getElementById("app").innerHTML = `
        <div class="card">
          <h2>ê²Œì„ ì¢…ë£Œ</h2>
          <p>${currentPlayer}ë‹˜ ì ìˆ˜: <b>${score}/5</b></p>
          <p>ì†Œìš”ì‹œê°„: <b>${elapsed}ì´ˆ</b></p>
          <p>${rankText}</p>
          ${tableHTML}
          <button class="nav-btn" onclick="showHome()">ì²˜ìŒìœ¼ë¡œ</button>
          <button class="nav-btn" onclick="showLeaderboardMenu()">ìˆœìœ„ í™•ì¸</button>
        </div>
      `;
    }

    function buildRankingSummary(gameType, player, sc, tm){
      const data = JSON.parse(localStorage.getItem("leaderboard") || "{}");
      const list = data[gameType] || [];
      // ë°©ê¸ˆ ê¸°ë¡ì˜ ìˆœìœ„ ì°¾ê¸° (ë™ì  ë‹¤ìˆ˜ ëŒ€ë¹„ íƒ€ì„ìŠ¤íƒ¬í”„ ê³ ë ¤)
      let idx = -1;
      for(let i=0;i<list.length;i++){
        const e = list[i];
        if(e.player===player && e.score===sc && e.time===tm){
          idx = i; break;
        }
      }
      const rankText = (idx>-1 && idx<10) ? `ì¶•í•˜í•©ë‹ˆë‹¤! ${idx+1}ìœ„ì…ë‹ˆë‹¤!! ğŸ‰` : `ì•„ì‰½ë„¤ìš”... ë¶„ë°œí•˜ì„¸ìš”!!`;

      let rows = list.map((e,i)=>`<tr><td>${i+1}</td><td>${e.player}</td><td>${e.score}</td><td>${e.time}ì´ˆ</td></tr>`).join("");
      const tableHTML = `
        <h3>ìˆœìœ„í‘œ (ê²Œì„ ${gameType})</h3>
        <table>
          <tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ì ìˆ˜</th><th>ì‹œê°„(ì´ˆ)</th></tr>
          ${rows}
        </table>
      `;
      return { rankText, tableHTML };
    }

    // ìˆœìœ„ í™•ì¸ ë©”ë‰´/í™”ë©´
    function showLeaderboardMenu(){
      document.getElementById("app").innerHTML = `
        <div class="card">
          <h2>ìˆœìœ„ í™•ì¸</h2>
          <button class="option-btn" onclick="showLeaderboard(1)">1. ë‚˜ë¼ â†’ ìˆ˜ë„</button>
          <button class="option-btn" onclick="showLeaderboard(2)">2. ìˆ˜ë„ â†’ ë‚˜ë¼</button>
          <button class="option-btn" onclick="showLeaderboard(3)">3. êµ­ê¸° â†’ ë‚˜ë¼</button>
          <button class="option-btn" onclick="showLeaderboard(4)">4. ë‚˜ë¼ â†’ êµ­ê¸°</button>
          <button class="nav-btn" onclick="showHome()">ì²˜ìŒìœ¼ë¡œ</button>
        </div>
      `;
    }

    function showLeaderboard(gameType){
      const data = JSON.parse(localStorage.getItem("leaderboard") || "{}");
      const list = data[gameType] || [];
      let rows = list.map((e,i)=>`<tr><td>${i+1}</td><td>${e.player}</td><td>${e.score}</td><td>${e.time}ì´ˆ</td></tr>`).join("");
      document.getElementById("app").innerHTML = `
        <div class="card">
          <h2>ê²Œì„ ${gameType} ìˆœìœ„</h2>
          <table>
            <tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ì ìˆ˜</th><th>ì‹œê°„(ì´ˆ)</th></tr>
            ${rows}
          </table>
          <button class="nav-btn" onclick="showLeaderboardMenu()">ë’¤ë¡œ</button>
        </div>
      `;
    }

    // ê³µë¶€ ëª¨ë“œ (í•„í„°)
    function showStudy(filter="ì „ì²´"){
      let filtered = countries;
      if(filter !== "ì „ì²´"){
        filtered = countries.filter(c=>c.continent_ko===filter);
      }
      const rows = [...filtered]
        .sort((a,b)=> a.continent_ko.localeCompare(b.continent_ko,"ko") || a.country_ko.localeCompare(b.country_ko,"ko"))
        .map(c=>`
          <tr>
            <td>${c.continent_ko}</td>
            <td><img src="${c.flag}" alt="flag" width="40"></td>
            <td>${c.country_ko}</td>
            <td>${c.capital_ko || ""}</td>
          </tr>`).join("");

      document.getElementById("app").innerHTML = `
        <div class="card">
          <h2>ë‚˜ë¼-ìˆ˜ë„-êµ­ê¸° ê³µë¶€</h2>
          <div>
            <button class="small-btn" onclick="showStudy('ì „ì²´')">ì „ì²´ë³´ê¸°</button>
            <button class="small-btn" onclick="showStudy('ì•„ë©”ë¦¬ì¹´')">ì•„ë©”ë¦¬ì¹´</button>
            <button class="small-btn" onclick="showStudy('ì•„ì‹œì•„')">ì•„ì‹œì•„</button>
            <button class="small-btn" onclick="showStudy('ì•„í”„ë¦¬ì¹´')">ì•„í”„ë¦¬ì¹´</button>
            <button class="small-btn" onclick="showStudy('ì˜¤ì„¸ì•„ë‹ˆì•„')">ì˜¤ì„¸ì•„ë‹ˆì•„</button>
            <button class="small-btn" onclick="showStudy('ìœ ëŸ½')">ìœ ëŸ½</button>
          </div>
          <table>
            <tr><th>ëŒ€ë¥™</th><th>êµ­ê¸°</th><th>êµ­ê°€</th><th>ìˆ˜ë„</th></tr>
            ${rows}
          </table>
          <button class="nav-btn" onclick="showHome()">ì²˜ìŒìœ¼ë¡œ</button>
        </div>
      `;
    }

    // ì‹œì‘
    loadData();
  </script>
</body>
</html>
