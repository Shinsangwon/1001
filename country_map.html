<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ì„¸ê³„ì§€ë„ ë‚˜ë¼ ë§íˆê¸° í€´ì¦ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif; margin: 0; background:#fafafa; }
    header { padding: 16px 20px; background: #111; color:#fff; }
    main { max-width: 1000px; margin: 0 auto; padding: 20px; }
    #map { width: 100%; height: 560px; background: #e9ecef; border-radius: 10px; }
    .panel { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:14px; }
    input[type="text"] { flex:1 1 260px; padding:10px 12px; font-size:16px; border:1px solid #ccc; border-radius:8px; }
    button { padding:10px 14px; font-size:15px; border:0; border-radius:8px; cursor:pointer; background:#111; color:#fff; }
    button.secondary { background:#444; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .choices { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .choice { padding:8px 10px; border:1px solid #ccc; border-radius:8px; background:#fff; cursor:pointer; }
    .choice.correct { background:#d1ffd6; border-color:#5dbb63; }
    .choice.wrong { background:#ffe1e1; border-color:#ff6b6b; }
    .status { margin-top:10px; font-weight:600; }
    .status.correct { color:#2f9e44; }
    .status.wrong { color:#c92a2a; }
    footer { color:#666; font-size:12px; text-align:center; padding:20px 10px; }
    .note { color:#666; font-size:13px; margin-top:6px; }
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0; font-size:20px;">ì„¸ê³„ì§€ë„ ë‚˜ë¼ ë§íˆê¸° í€´ì¦ˆ</h1>
  </header>

  <main>
    <div id="map"></div>

    <div class="panel">
      <input id="answer" type="text" placeholder="ì–´ëŠ ë‚˜ë¼ì¼ê¹Œìš”? (í•œêµ­ì–´/ì˜ì–´ ëª¨ë‘ OK)" />
      <button id="checkBtn">ì •ë‹µ í™•ì¸</button>
      <button id="revealBtn" class="secondary">ì •ë‹µ ë³´ê¸°</button>
      <button id="nextBtn">ë‹¤ìŒ ë¬¸ì œ</button>
    </div>

    <div class="choices" id="choices"></div>
    <div class="status" id="status"></div>
    <div class="note">íŒíŠ¸: ì¢Œìš° ë“œë˜ê·¸ë¡œ ì§€ë„ë¥¼ ì›€ì§ì¼ ìˆ˜ ìˆì–´ìš”(í”„ë¡œì ì…˜ ì¬íˆ¬ì˜). íœ ë¡œ í™•ëŒ€/ì¶•ì†ŒëŠ” ì œí•œë©ë‹ˆë‹¤.</div>
  </main>

  <footer>
    Â© Country Quiz â€“ D3 + GeoJSON | êµìœ¡ìš©ìœ¼ë¡œ ììœ ë¡­ê²Œ ìˆ˜ì •í•˜ì„¸ìš”.
  </footer>

  <!-- D3 & TopoJSON (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>

  <script>
    // ====== ì„¤ì • ======
    const GEOJSON_URL = "https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json";
    // í•œê¸€/ì˜ë¬¸ ì •ë‹µ í—ˆìš©ì„ ìœ„í•œ ì´ë¦„ ë§¤í•‘(í•„ìš” ì‹œ ê³„ì† ì¶”ê°€í•˜ì„¸ìš”)
    const extraNames = {
      "Korea, Republic of": ["ëŒ€í•œë¯¼êµ­","í•œêµ­","South Korea","Republic of Korea","Korea (South)"],
      "Korea, Democratic People's Republic of": ["ì¡°ì„ ë¯¼ì£¼ì£¼ì˜ì¸ë¯¼ê³µí™”êµ­","ë¶í•œ","North Korea","DPRK","Korea (North)"],
      "Cote d'Ivoire": ["ì½”íŠ¸ë””ë¶€ì•„ë¥´","CÃ´te dâ€™Ivoire","Ivory Coast"],
      "Czech Republic": ["ì²´ì½”","Czechia"],
      "Russian Federation": ["ëŸ¬ì‹œì•„","Russia"],
      "United States of America": ["ë¯¸êµ­","ë¯¸ í•©ì¤‘êµ­","USA","United States","US","U.S."],
      "United Kingdom": ["ì˜êµ­","UK","U.K.","Britain","Great Britain"],
      "Myanmar": ["ë¯¸ì–€ë§ˆ","ë²„ë§ˆ","Burma"],
      "Lao People's Democratic Republic": ["ë¼ì˜¤ìŠ¤","Laos"],
      "Viet Nam": ["ë² íŠ¸ë‚¨","Vietnam"],
      "Syrian Arab Republic": ["ì‹œë¦¬ì•„","Syria"],
      "Iran, Islamic Republic of": ["ì´ë€","Iran"],
      "Venezuela, Bolivarian Republic of": ["ë² ë„¤ìˆ˜ì—˜ë¼","Venezuela"],
      "Bolivia, Plurinational State of": ["ë³¼ë¦¬ë¹„ì•„","Bolivia"],
      "United Republic of Tanzania": ["íƒ„ìë‹ˆì•„","Tanzania"],
      "Congo, The Democratic Republic of the": ["ì½©ê³ ë¯¼ì£¼ê³µí™”êµ­","DR Congo","Democratic Republic of the Congo","DRC"],
      "Congo": ["ì½©ê³ ê³µí™”êµ­","Republic of the Congo","Congo (Republic)"],
      "Micronesia, Federated States of": ["ë¯¸í¬ë¡œë„¤ì‹œì•„","FSM"],
      "Brunei Darussalam": ["ë¸Œë£¨ë‚˜ì´","Brunei"],
      "Cabo Verde": ["ì¹´ë³´ë² ë¥´ë°","Cape Verde"]
    };

    // ====== ì „ì—­ ìƒíƒœ ======
    let features = [];     // GeoJSON Feature ëª©ë¡(êµ­ê°€)
    let current = null;    // í˜„ì¬ ë¬¸ì œ(Feature)
    let nameIndex = {};    // ì •ë‹µ ë¹„êµìš© ì¸ë±ìŠ¤

    // ====== ì§€ë„ ì¤€ë¹„ ======
    const width = Math.min(1000, window.innerWidth - 40);
    const height = 560;

    const svg = d3.select("#map").append("svg")
      .attr("viewBox", `0 0 ${width} ${height}`)
      .style("width", "100%")
      .style("height", "100%");

    const projection = d3.geoEqualEarth()
      .translate([width/2, height/2])
      .scale(Math.min(width, height) * 0.32);

    const path = d3.geoPath(projection);

    // ë°°ê²½(ë°”ë‹¤)
    svg.append("rect")
      .attr("width", width)
      .attr("height", height)
      .attr("fill", "#dfe7ef");

    // êµ¬ë©´ ìœ¤ê³½ & ê²½ìœ„ì„ 
    const graticule = d3.geoGraticule10();
    svg.append("path").attr("d", path({type:"Sphere"}))
      .attr("fill", "#cfe5ff").attr("stroke", "#8fb5d9");
    svg.append("path").attr("d", path(graticule))
      .attr("fill", "none").attr("stroke", "#b9c6d2").attr("stroke-width", 0.5).attr("opacity",0.6);

    const gCountries = svg.append("g");

    // ë“œë˜ê·¸ë¡œ ì§€êµ¬ íšŒì „(ê°„ë‹¨í•œ yaw)
    let yaw = 0;
    svg.call(d3.drag().on("drag", (event) => {
      yaw += event.dx * 0.5; // ê°ë„
      projection.rotate([yaw, 0, 0]);
      redraw();
    }));

    function redraw() {
      gCountries.selectAll("path").attr("d", path);
      svg.selectAll("path.grat").attr("d", path(graticule));
      svg.selectAll("path.sphere").attr("d", path({type:"Sphere"}));
    }

    // ====== ë°ì´í„° ë¡œë“œ ======
    fetch(GEOJSON_URL)
      .then(r => r.json())
      .then(data => {
        features = data.features.filter(f => f.properties && f.properties.name);
        // ì´ë¦„ ì¸ë±ìŠ¤ êµ¬ì¶•(ì†Œë¬¸ì íŠ¸ë¦¼ ë¹„êµ)
        features.forEach(f => {
          const official = f.properties.name;
          const variants = new Set([official]);
          (extraNames[official] || []).forEach(v => variants.add(v));
          // í”í•œ ë³€í˜• ì¶”ê°€(í•˜ì´í”ˆ/ì‰¼í‘œ ê³µë°± ë“± ì œê±°)
          const normalized = Array.from(variants).flatMap(v => {
            const base = v.trim();
            return [
              base,
              base.replace(/â€™/g,"'"),
              base.replace(/\s+/g," "),
              base.replace(/[.,()]/g,""),
            ];
          });
          normalized.forEach(v => nameIndex[v.toLowerCase()] = official);
        });

        drawBaseMap();
        nextQuestion();
      })
      .catch(err => {
        console.error(err);
        d3.select("#status").attr("class","status wrong").text("ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.");
      });

    function drawBaseMap() {
      gCountries.selectAll("path.country")
        .data(features)
        .join("path")
        .attr("class", "country")
        .attr("d", path)
        .attr("fill", "#e9ecef")
        .attr("stroke", "#999")
        .attr("stroke-width", 0.5);
    }

    function pickRandomCountry() {
      // ë©´ì ì´ ë„ˆë¬´ ì‘ì•„ ë³´ì´ê¸° ì–´ë ¤ìš´ ë„ì„œêµ­ê°€ ëª‡ëª‡ì€ í™•ë¥ ì„ ë‚®ì¶”ê³  ì‹¶ë‹¤ë©´ ì—¬ê¸°ì„œ í•„í„°/ê°€ì¤‘ì¹˜ ê°€ëŠ¥
      return features[Math.floor(Math.random()*features.length)];
    }

    function highlightCountry(f) {
      gCountries.selectAll("path.country")
        .attr("fill", d => (d === f ? "#5c7cfa" : "#e9ecef"))
        .attr("stroke", d => (d === f ? "#172b4d" : "#999"))
        .attr("stroke-width", d => (d === f ? 1.2 : 0.5));
    }

    function makeChoices(correctName) {
      const names = features.map(f => f.properties.name).filter(n => n !== correctName);
      // ë¬´ì‘ìœ„ 3ê°œ ì˜¤ë‹µ + ì •ë‹µ â†’ ì„ê¸°
      const choices = new Set();
      while (choices.size < 3) {
        choices.add(names[Math.floor(Math.random()*names.length)]);
      }
      const four = d3.shuffle([correctName, ...choices]);
      const box = d3.select("#choices").html("");
      four.forEach(n => {
        box.append("div")
          .attr("class","choice")
          .text(n)
          .on("click", () => checkAnswer(n));
      });
    }

    function normalizeInput(s) {
      return s.trim().toLowerCase().replace(/\s+/g," ");
    }

    function checkAnswer(raw) {
      const status = d3.select("#status").attr("class","status");
      const guess = typeof raw === "string" ? raw : document.getElementById("answer").value;
      const norm = normalizeInput(guess);
      const mapped = nameIndex[norm] || null;
      const correct = current.properties.name;

      const isCorrect =
        (mapped && mapped === correct) ||
        normalizeInput(correct) === norm;

      // ê°ê´€ì‹ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë°˜ì˜
      d3.selectAll(".choice").each(function() {
        const el = d3.select(this);
        const txt = el.text();
        if (txt === correct) el.classed("correct", true);
        if (guess && txt === guess && txt !== correct) el.classed("wrong", true);
      });

      if (isCorrect) {
        status.attr("class","status correct").text(`ì •ë‹µ! âœ… ${correct}`);
      } else {
        status.attr("class","status wrong").text(`ì•„ì‰¬ì›Œìš” ğŸ˜… ì •ë‹µì€ ${correct}`);
      }
    }

    function revealAnswer() {
      const correct = current?.properties?.name;
      if (!correct) return;
      d3.select("#status").attr("class","status").text(`ì •ë‹µ: ${correct}`);
      d3.selectAll(".choice").each(function() {
        const el = d3.select(this);
        if (el.text() === correct) el.classed("correct", true);
      });
    }

    function nextQuestion() {
      d3.select("#status").attr("class","status").text("");
      document.getElementById("answer").value = "";
      current = pickRandomCountry();
      highlightCountry(current);
      makeChoices(current.properties.name);
    }

    // ====== ì´ë²¤íŠ¸ ë°”ì¸ë”© ======
    document.getElementById("checkBtn").addEventListener("click", () => checkAnswer());
    document.getElementById("revealBtn").addEventListener("click", revealAnswer);
    document.getElementById("nextBtn").addEventListener("click", nextQuestion);
    document.getElementById("answer").addEventListener("keydown", (e) => {
      if (e.key === "Enter") checkAnswer();
    });
  </script>
</body>
</html>
