<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>세계지도 나라 맞히기 퀴즈</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif; margin: 0; background:#fafafa; }
    header { padding: 16px 20px; background: #111; color:#fff; }
    main { max-width: 1000px; margin: 0 auto; padding: 20px; }
    #map { width: 100%; height: 560px; background: #e9ecef; border-radius: 10px; }
    .panel { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:14px; }
    input[type="text"] { flex:1 1 260px; padding:10px 12px; font-size:16px; border:1px solid #ccc; border-radius:8px; }
    button { padding:10px 14px; font-size:15px; border:0; border-radius:8px; cursor:pointer; background:#111; color:#fff; }
    button.secondary { background:#444; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .choices { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .choice { padding:8px 10px; border:1px solid #ccc; border-radius:8px; background:#fff; cursor:pointer; }
    .choice.correct { background:#d1ffd6; border-color:#5dbb63; }
    .choice.wrong { background:#ffe1e1; border-color:#ff6b6b; }
    .status { margin-top:10px; font-weight:600; }
    .status.correct { color:#2f9e44; }
    .status.wrong { color:#c92a2a; }
    footer { color:#666; font-size:12px; text-align:center; padding:20px 10px; }
    .note { color:#666; font-size:13px; margin-top:6px; }
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0; font-size:20px;">세계지도 나라 맞히기 퀴즈</h1>
  </header>

  <main>
    <div id="map"></div>

    <div class="panel">
      <input id="answer" type="text" placeholder="어느 나라일까요? (한국어/영어 모두 OK)" />
      <button id="checkBtn">정답 확인</button>
      <button id="revealBtn" class="secondary">정답 보기</button>
      <button id="nextBtn">다음 문제</button>
    </div>

    <div class="choices" id="choices"></div>
    <div class="status" id="status"></div>
    <div class="note">힌트: 좌우 드래그로 지도를 움직일 수 있어요(프로젝션 재투영). 휠로 확대/축소는 제한됩니다.</div>
  </main>

  <footer>
    © Country Quiz – D3 + GeoJSON | 교육용으로 자유롭게 수정하세요.
  </footer>

  <!-- D3 & TopoJSON (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>

  <script>
    // ====== 설정 ======
    const GEOJSON_URL = "https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json";
    // 한글/영문 정답 허용을 위한 이름 매핑(필요 시 계속 추가하세요)
    const extraNames = {
      "Korea, Republic of": ["대한민국","한국","South Korea","Republic of Korea","Korea (South)"],
      "Korea, Democratic People's Republic of": ["조선민주주의인민공화국","북한","North Korea","DPRK","Korea (North)"],
      "Cote d'Ivoire": ["코트디부아르","Côte d’Ivoire","Ivory Coast"],
      "Czech Republic": ["체코","Czechia"],
      "Russian Federation": ["러시아","Russia"],
      "United States of America": ["미국","미 합중국","USA","United States","US","U.S."],
      "United Kingdom": ["영국","UK","U.K.","Britain","Great Britain"],
      "Myanmar": ["미얀마","버마","Burma"],
      "Lao People's Democratic Republic": ["라오스","Laos"],
      "Viet Nam": ["베트남","Vietnam"],
      "Syrian Arab Republic": ["시리아","Syria"],
      "Iran, Islamic Republic of": ["이란","Iran"],
      "Venezuela, Bolivarian Republic of": ["베네수엘라","Venezuela"],
      "Bolivia, Plurinational State of": ["볼리비아","Bolivia"],
      "United Republic of Tanzania": ["탄자니아","Tanzania"],
      "Congo, The Democratic Republic of the": ["콩고민주공화국","DR Congo","Democratic Republic of the Congo","DRC"],
      "Congo": ["콩고공화국","Republic of the Congo","Congo (Republic)"],
      "Micronesia, Federated States of": ["미크로네시아","FSM"],
      "Brunei Darussalam": ["브루나이","Brunei"],
      "Cabo Verde": ["카보베르데","Cape Verde"]
    };

    // ====== 전역 상태 ======
    let features = [];     // GeoJSON Feature 목록(국가)
    let current = null;    // 현재 문제(Feature)
    let nameIndex = {};    // 정답 비교용 인덱스

    // ====== 지도 준비 ======
    const width = Math.min(1000, window.innerWidth - 40);
    const height = 560;

    const svg = d3.select("#map").append("svg")
      .attr("viewBox", `0 0 ${width} ${height}`)
      .style("width", "100%")
      .style("height", "100%");

    const projection = d3.geoEqualEarth()
      .translate([width/2, height/2])
      .scale(Math.min(width, height) * 0.32);

    const path = d3.geoPath(projection);

    // 배경(바다)
    svg.append("rect")
      .attr("width", width)
      .attr("height", height)
      .attr("fill", "#dfe7ef");

    // 구면 윤곽 & 경위선
    const graticule = d3.geoGraticule10();
    svg.append("path").attr("d", path({type:"Sphere"}))
      .attr("fill", "#cfe5ff").attr("stroke", "#8fb5d9");
    svg.append("path").attr("d", path(graticule))
      .attr("fill", "none").attr("stroke", "#b9c6d2").attr("stroke-width", 0.5).attr("opacity",0.6);

    const gCountries = svg.append("g");

    // 드래그로 지구 회전(간단한 yaw)
    let yaw = 0;
    svg.call(d3.drag().on("drag", (event) => {
      yaw += event.dx * 0.5; // 감도
      projection.rotate([yaw, 0, 0]);
      redraw();
    }));

    function redraw() {
      gCountries.selectAll("path").attr("d", path);
      svg.selectAll("path.grat").attr("d", path(graticule));
      svg.selectAll("path.sphere").attr("d", path({type:"Sphere"}));
    }

    // ====== 데이터 로드 ======
    fetch(GEOJSON_URL)
      .then(r => r.json())
      .then(data => {
        features = data.features.filter(f => f.properties && f.properties.name);
        // 이름 인덱스 구축(소문자 트림 비교)
        features.forEach(f => {
          const official = f.properties.name;
          const variants = new Set([official]);
          (extraNames[official] || []).forEach(v => variants.add(v));
          // 흔한 변형 추가(하이픈/쉼표 공백 등 제거)
          const normalized = Array.from(variants).flatMap(v => {
            const base = v.trim();
            return [
              base,
              base.replace(/’/g,"'"),
              base.replace(/\s+/g," "),
              base.replace(/[.,()]/g,""),
            ];
          });
          normalized.forEach(v => nameIndex[v.toLowerCase()] = official);
        });

        drawBaseMap();
        nextQuestion();
      })
      .catch(err => {
        console.error(err);
        d3.select("#status").attr("class","status wrong").text("지도를 불러오지 못했어요. 인터넷 연결을 확인해 주세요.");
      });

    function drawBaseMap() {
      gCountries.selectAll("path.country")
        .data(features)
        .join("path")
        .attr("class", "country")
        .attr("d", path)
        .attr("fill", "#e9ecef")
        .attr("stroke", "#999")
        .attr("stroke-width", 0.5);
    }

    function pickRandomCountry() {
      // 면적이 너무 작아 보이기 어려운 도서국가 몇몇은 확률을 낮추고 싶다면 여기서 필터/가중치 가능
      return features[Math.floor(Math.random()*features.length)];
    }

    function highlightCountry(f) {
      gCountries.selectAll("path.country")
        .attr("fill", d => (d === f ? "#5c7cfa" : "#e9ecef"))
        .attr("stroke", d => (d === f ? "#172b4d" : "#999"))
        .attr("stroke-width", d => (d === f ? 1.2 : 0.5));
    }

    function makeChoices(correctName) {
      const names = features.map(f => f.properties.name).filter(n => n !== correctName);
      // 무작위 3개 오답 + 정답 → 섞기
      const choices = new Set();
      while (choices.size < 3) {
        choices.add(names[Math.floor(Math.random()*names.length)]);
      }
      const four = d3.shuffle([correctName, ...choices]);
      const box = d3.select("#choices").html("");
      four.forEach(n => {
        box.append("div")
          .attr("class","choice")
          .text(n)
          .on("click", () => checkAnswer(n));
      });
    }

    function normalizeInput(s) {
      return s.trim().toLowerCase().replace(/\s+/g," ");
    }

    function checkAnswer(raw) {
      const status = d3.select("#status").attr("class","status");
      const guess = typeof raw === "string" ? raw : document.getElementById("answer").value;
      const norm = normalizeInput(guess);
      const mapped = nameIndex[norm] || null;
      const correct = current.properties.name;

      const isCorrect =
        (mapped && mapped === correct) ||
        normalizeInput(correct) === norm;

      // 객관식 버튼 스타일 반영
      d3.selectAll(".choice").each(function() {
        const el = d3.select(this);
        const txt = el.text();
        if (txt === correct) el.classed("correct", true);
        if (guess && txt === guess && txt !== correct) el.classed("wrong", true);
      });

      if (isCorrect) {
        status.attr("class","status correct").text(`정답! ✅ ${correct}`);
      } else {
        status.attr("class","status wrong").text(`아쉬워요 😅 정답은 ${correct}`);
      }
    }

    function revealAnswer() {
      const correct = current?.properties?.name;
      if (!correct) return;
      d3.select("#status").attr("class","status").text(`정답: ${correct}`);
      d3.selectAll(".choice").each(function() {
        const el = d3.select(this);
        if (el.text() === correct) el.classed("correct", true);
      });
    }

    function nextQuestion() {
      d3.select("#status").attr("class","status").text("");
      document.getElementById("answer").value = "";
      current = pickRandomCountry();
      highlightCountry(current);
      makeChoices(current.properties.name);
    }

    // ====== 이벤트 바인딩 ======
    document.getElementById("checkBtn").addEventListener("click", () => checkAnswer());
    document.getElementById("revealBtn").addEventListener("click", revealAnswer);
    document.getElementById("nextBtn").addEventListener("click", nextQuestion);
    document.getElementById("answer").addEventListener("keydown", (e) => {
      if (e.key === "Enter") checkAnswer();
    });
  </script>
</body>
</html>
