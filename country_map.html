<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>세계지도 나라 맞히기 퀴즈 (countries.json 연동)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, "Noto Sans KR", sans-serif; margin: 0; background:#fafafa; }
    header { padding: 16px 20px; background: #111; color:#fff; }
    main { max-width: 1000px; margin: 0 auto; padding: 20px; }
    #map { width: 100%; height: 560px; background: #e9ecef; border-radius: 10px; }
    .panel { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:14px; }
    input[type="text"] { flex:1 1 260px; padding:10px 12px; font-size:16px; border:1px solid #ccc; border-radius:8px; }
    button { padding:10px 14px; font-size:15px; border:0; border-radius:8px; cursor:pointer; background:#111; color:#fff; }
    button.secondary { background:#444; }
    .choices { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .choice { padding:8px 10px; border:1px solid #ccc; border-radius:8px; background:#fff; cursor:pointer; }
    .choice.correct { background:#d1ffd6; border-color:#5dbb63; }
    .choice.wrong { background:#ffe1e1; border-color:#ff6b6b; }
    .status { margin-top:10px; font-weight:600; }
    .status.correct { color:#2f9e44; }
    .status.wrong { color:#c92a2a; }
    footer { color:#666; font-size:12px; text-align:center; padding:20px 10px; }
    .note { color:#666; font-size:13px; margin-top:6px; }
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0; font-size:20px;">세계지도 나라 맞히기 퀴즈</h1>
  </header>

  <main>
    <div id="map"></div>

    <div class="panel">
      <input id="answer" type="text" placeholder="어느 나라일까요? (한국어/영어 모두 OK)" />
      <button id="checkBtn">정답 확인</button>
      <button id="revealBtn" class="secondary">정답 보기</button>
      <button id="nextBtn">다음 문제</button>
    </div>

    <div class="choices" id="choices"></div>
    <div class="status" id="status"></div>
    <div class="note">마우스 휠로 확대/축소, 드래그로 이동할 수 있어요.</div>
  </main>

  <footer>
    © Country Quiz – D3 + GeoJSON + countries.json | 교육용으로 자유롭게 수정하세요.
  </footer>

  <!-- D3 & TopoJSON -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>

  <script>
    const GEOJSON_URL = "https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json";
    const COUNTRY_JSON_URL = "countries.json"; // 같은 폴더에 두세요

    let features = [];
    let current = null;
    let koreanNames = {};
    let nameIndex = {};

    const width = Math.min(1000, window.innerWidth - 40);
    const height = 560;

    const svg = d3.select("#map").append("svg")
      .attr("viewBox", `0 0 ${width} ${height}`)
      .style("width", "100%")
      .style("height", "100%");

    const projection = d3.geoEqualEarth()
      .translate([width/2, height/2])
      .scale(Math.min(width, height) * 0.32);

    const path = d3.geoPath(projection);

    svg.append("rect")
      .attr("width", width)
      .attr("height", height)
      .attr("fill", "#dfe7ef");

    const gCountries = svg.append("g");

    // 줌/이동
    const zoom = d3.zoom()
      .scaleExtent([1, 8])
      .on("zoom", (event) => {
        gCountries.attr("transform", event.transform);
      });
    svg.call(zoom);

    // 두 데이터 동시에 로드
    Promise.all([
      fetch(GEOJSON_URL).then(r => r.json()),
      fetch(COUNTRY_JSON_URL).then(r => r.json())
    ]).then(([geoData, countryData]) => {
      features = geoData.features.filter(f => f.properties && f.properties.name);

      // 영어 → 한국어 매핑
      countryData.forEach(c => {
        koreanNames[c.country_en] = c.country_ko;
        // 검색 편의성을 위해 인덱스에 영어/한글 둘 다 추가
        nameIndex[c.country_en.toLowerCase()] = c.country_en;
        nameIndex[c.country_ko.toLowerCase()] = c.country_en;
      });

      drawBaseMap();
      nextQuestion();
    }).catch(err => {
      console.error(err);
      d3.select("#status").attr("class","status wrong").text("데이터를 불러오지 못했어요.");
    });

    function drawBaseMap() {
      gCountries.selectAll("path.country")
        .data(features)
        .join("path")
        .attr("class", "country")
        .attr("d", path)
        .attr("fill", "#e9ecef")
        .attr("stroke", "#999")
        .attr("stroke-width", 0.5);
    }

    function pickRandomCountry() {
      return features[Math.floor(Math.random()*features.length)];
    }

    function highlightCountry(f) {
      gCountries.selectAll("path.country")
        .attr("fill", d => (d === f ? "#5c7cfa" : "#e9ecef"))
        .attr("stroke", d => (d === f ? "#172b4d" : "#999"))
        .attr("stroke-width", d => (d === f ? 1.2 : 0.5));
    }

    function getDisplayName(name) {
      return koreanNames[name] || name;
    }

    function makeChoices(correctName) {
      const names = features.map(f => f.properties.name).filter(n => n !== correctName);
      const choices = new Set();
      while (choices.size < 3) {
        choices.add(names[Math.floor(Math.random()*names.length)]);
      }
      const four = d3.shuffle([correctName, ...choices]);
      const box = d3.select("#choices").html("");
      four.forEach(n => {
        box.append("div")
          .attr("class","choice")
          .text(getDisplayName(n))
          .on("click", () => checkAnswer(n));
      });
    }

    function normalizeInput(s) {
      return s.trim().toLowerCase();
    }

    function checkAnswer(raw) {
      const status = d3.select("#status").attr("class","status");
      const guess = typeof raw === "string" ? raw : document.getElementById("answer").value;
      const norm = normalizeInput(guess);
      const mapped = nameIndex[norm] || null;
      const correct = current.properties.name;

      const isCorrect =
        (mapped && mapped === correct) ||
        normalizeInput(correct) === norm ||
        normalizeInput(getDisplayName(correct)) === norm;

      d3.selectAll(".choice").each(function() {
        const el = d3.select(this);
        if (el.text() === getDisplayName(correct)) el.classed("correct", true);
        if (guess && el.text() === guess && getDisplayName(correct) !== guess) el.classed("wrong", true);
      });

      if (isCorrect) {
        status.attr("class","status correct").text(`정답! ✅ ${getDisplayName(correct)}`);
      } else {
        status.attr("class","status wrong").text(`아쉬워요 😅 정답은 ${getDisplayName(correct)}`);
      }
    }

    function revealAnswer() {
      const correct = current?.properties?.name;
      if (!correct) return;
      d3.select("#status").attr("class","status").text(`정답: ${getDisplayName(correct)}`);
      d3.selectAll(".choice").each(function() {
        const el = d3.select(this);
        if (el.text() === getDisplayName(correct)) el.classed("correct", true);
      });
    }

    function nextQuestion() {
      d3.select("#status").attr("class","status").text("");
      document.getElementById("answer").value = "";
      current = pickRandomCountry();
      highlightCountry(current);
      makeChoices(current.properties.name);
    }

    document.getElementById("checkBtn").addEventListener("click", () => checkAnswer());
    document.getElementById("revealBtn").addEventListener("click", revealAnswer);
    document.getElementById("nextBtn").addEventListener("click", nextQuestion);
    document.getElementById("answer").addEventListener("keydown", (e) => {
      if (e.key === "Enter") checkAnswer();
    });
  </script>
</body>
</html>
