<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë§ì…ˆ & ëª¨ìœ¼ê¸°/ê°€ë¥´ê¸° ê²Œì„</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Malgun Gothic,Apple SD Gothic Neo,sans-serif;background:#ffe4ec;color:#222;min-height:100vh;display:flex;align-items:center;justify-content:center}
    .wrap{max-width:640px;width:100%;padding:16px}
    h1{text-align:center;font-size:28px;margin:12px 0;color:#ff4081}
    .desc{font-size:15px;color:#555;text-align:center;margin-bottom:16px}
    .card{background:#fff;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.12);padding:20px;margin-bottom:16px}
    .problem-box{border:3px solid #ff6fa0;border-radius:12px;padding:20px;text-align:center;background:#fff0f5;}
    .problem{font-size:24px;font-weight:bold;margin:10px 0;line-height:1.8}
    .question-number{font-size:16px;color:#555;margin-bottom:8px}
    .keypad{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:16px}
    .keypad button{padding:14px;font-size:18px;border:none;border-radius:8px;background:#ffb6c1;cursor:pointer;transition:.2s}
    .keypad button:hover{background:#ff91af}
    .feedback{text-align:center;margin-top:12px;height:24px;font-weight:bold}
    .ok{color:green}.bad{color:red}
    #timerAdd,#timerSplit{font-weight:bold;font-size:18px}
    .results{padding:20px;text-align:center}
    .results h2{text-align:center;margin:0 0 8px}
    .finish-message{font-size:24px;color:#ff4081;font-weight:bold;margin-bottom:16px}
    .center-btn{display:flex;justify-content:center;margin-top:20px;gap:10px;flex-wrap:wrap}
    .start-big{padding:20px 40px;font-size:22px;border:none;border-radius:12px;background:#ff4081;color:#fff;font-weight:bold;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,0.2);transition:.2s}
    .start-big:hover{background:#e73370}
    .blank{display:inline-block;min-width:40px;border-bottom:2px solid #ff4081;margin:0 4px;padding:2px 6px;font-size:28px;color:#111;border-radius:6px}
    .blank.active{background:#ffd6e6;border-bottom:3px solid #ff4081;box-shadow:0 0 0 3px rgba(255,64,129,.15)}
    .char-btn{padding:10px 18px;margin:4px;font-size:16px;border:none;border-radius:8px;background:#ffe0eb;cursor:pointer}
    .char-btn.selected{background:#ff4081;color:#fff}
    /* ìˆœìœ„í‘œ: í™©ê¸ˆ í…Œë§ˆ */
    .ranking {margin-top:20px;padding:16px;border-radius:12px;background:linear-gradient(135deg,#fff8dc,#ffd700);box-shadow:0 4px 10px rgba(0,0,0,0.15)}
    .ranking h3 {color:#b8860b;text-align:center;margin-bottom:12px;font-size:20px}
    .ranking ol {list-style:none;padding:0;margin:0}
    .ranking li {margin:6px 0;padding:8px 12px;border-radius:8px;font-size:16px;font-weight:bold;background:#fffbe6;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
    .ranking li:first-child {background:linear-gradient(135deg,#fffacd,#ffd700);color:#8b7500}
    .ranking li:nth-child(2) {background:linear-gradient(135deg,#f0f0f0,#c0c0c0);color:#444}
    .ranking li:nth-child(3) {background:linear-gradient(135deg,#fff0e0,#cd7f32);color:#5a3a1a}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ê²Œì„ ì„ íƒ</h1>
    <div class="desc">
      <p><b>ë§ì…ˆ ê²Œì„</b>: 1~20 ë²„íŠ¼ìœ¼ë¡œ ì •ë‹µì„ ì…ë ¥í•˜ì—¬ ë¹ ë¥´ê²Œ í‘¸ëŠ” ê²Œì„ (5ë¬¸ì œ ì„¸íŠ¸)</p>
      <p><b>ëª¨ìœ¼ê¸°ì™€ ê°€ë¥´ê¸°</b>: ê¸°ì¤€ ìˆ˜(p)ë¥¼ í™œìš©í•´ ì‹ì„ ë‹¨ê³„ë³„ë¡œ ì™„ì„±í•©ë‹ˆë‹¤. ë²„íŠ¼ìœ¼ë¡œ ë¹ˆì¹¸ 3ê°œë¥¼ <b>ìˆœì„œëŒ€ë¡œ</b> ë§í˜€ì•¼ í•©ë‹ˆë‹¤ (3ë¬¸ì œ ì„¸íŠ¸)</p>
    </div>
    <div id="startScreen" class="card">
      <div style="margin-bottom:12px;">ìºë¦­í„° ì„ íƒ:</div>
      <div>
        <button type="button" class="char-btn" data-name="ì‹ ì¤€ì—´">ì‹ ì¤€ì—´</button>
        <button type="button" class="char-btn" data-name="ì‹ ê·œì—´">ì‹ ê·œì—´</button>
        <button type="button" class="char-btn" data-name="íŒŒë‹¥ì´">íŒŒë‹¥ì´</button>
        <button type="button" class="char-btn" data-name="ìˆ˜ë°•ì´">ìˆ˜ë°•ì´</button>
      </div>
      <div style="margin:12px 0;">ë˜ëŠ” ì§ì ‘ ì…ë ¥:</div>
      <input id="playerName" placeholder="ì´ë¦„ ì…ë ¥ (ì—†ìœ¼ë©´ ìºë¦­í„°/ë¬´ëª…)" />
      <div class="center-btn">
        <button type="button" id="additionSelect" class="start-big">1. ë§ì…ˆ ê²Œì„</button>
        <button type="button" id="splitSelect" class="start-big">2. ëª¨ìœ¼ê¸°ì™€ ê°€ë¥´ê¸°</button>
      </div>
    </div>

    <!-- ë§ì…ˆ ê²Œì„ í™”ë©´ -->
    <div id="additionGameScreen" class="card problem-box" hidden>
      <div class="question-number" id="qNumberAdd"></div>
      <div id="problemBoxAdd" class="problem"></div>
      <div id="keypadAdd" class="keypad"></div>
      <div id="feedbackAdd" class="feedback"></div>
      <div style="margin-top:12px;text-align:center"><span id="timerAdd">0.00ì´ˆ</span></div>
      <div class="center-btn"><button type="button" id="backFromAdd" class="start-big">ê²Œì„ì„ íƒìœ¼ë¡œ</button></div>
    </div>

    <!-- ëª¨ìœ¼ê¸°/ê°€ë¥´ê¸° ê²Œì„ í™”ë©´ -->
    <div id="splitGameScreen" class="card problem-box" hidden>
      <div class="question-number" id="qNumberSplit"></div>
      <div id="problemBoxSplit" class="problem"></div>
      <div id="keypadSplit" class="keypad"></div>
      <div id="feedbackSplit" class="feedback"></div>
      <div style="margin-top:12px;text-align:center"><span id="timerSplit">0.00ì´ˆ</span></div>
      <div class="center-btn"><button type="button" id="backFromSplit" class="start-big">ê²Œì„ì„ íƒìœ¼ë¡œ</button></div>
    </div>

    <!-- ê²°ê³¼ í™”ë©´ ê³µí†µ -->
    <div id="results" class="card results" hidden>
      <div class="finish-message">ìˆ˜ê³ í–ˆì–´ìš”!</div>
      <h2>ê²°ê³¼</h2>
      <div>ì´ ì†Œìš”ì‹œê°„: <span id="totalTime"></span></div>
      <div>ì •ë‹µ ê°œìˆ˜: <span id="correctCount"></span></div>
      <div>í‰ê·  ì‹œê°„/ë¬¸ì œ: <span id="avgTime"></span></div>
      <div>ì˜¤ë‹µ ì‹œë„: <span id="mistakes"></span></div>
      <div class="ranking">
        <h3 id="rankingTitle">ğŸ† ìˆœìœ„í‘œ ğŸ†</h3>
        <div id="rankInfo"></div>
        <ol id="rankingList"></ol>
      </div>
      <div class="center-btn">
        <button type="button" id="restartBtn" class="start-big">ê²Œì„ì„ íƒìœ¼ë¡œ</button>
      </div>
    </div>
  </div>

  <audio id="soundCorrect" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
  <audio id="soundWrong" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

  <script>
  document.addEventListener('DOMContentLoaded',function(){
    // --- ìºë¦­í„° ì„ íƒ/ìˆ˜ë™ ì…ë ¥ ---
    const charButtons = document.querySelectorAll('.char-btn');
    let selectedChar = '';
    charButtons.forEach(btn=>{
      btn.addEventListener('click',()=>{
        charButtons.forEach(b=>b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedChar = btn.dataset.name;
      });
    });
    function getPlayerName(){
      const manual = document.getElementById('playerName').value.trim();
      if(manual) return manual;
      if(selectedChar) return selectedChar;
      return 'ë¬´ëª…';
    }

    // --- DOM ì°¸ì¡° ---
    const additionSelect=document.getElementById('additionSelect');
    const splitSelect=document.getElementById('splitSelect');
    const startScreen=document.getElementById('startScreen');
    const additionScreen=document.getElementById('additionGameScreen');
    const splitScreen=document.getElementById('splitGameScreen');
    const results=document.getElementById('results');

    const qNumberAdd=document.getElementById('qNumberAdd');
    const problemBoxAdd=document.getElementById('problemBoxAdd');
    const feedbackAdd=document.getElementById('feedbackAdd');
    const timerAdd=document.getElementById('timerAdd');
    const keypadAdd=document.getElementById('keypadAdd');
    const backFromAdd=document.getElementById('backFromAdd');

    const qNumberSplit=document.getElementById('qNumberSplit');
    const problemBoxSplit=document.getElementById('problemBoxSplit');
    const feedbackSplit=document.getElementById('feedbackSplit');
    const timerSplit=document.getElementById('timerSplit');
    const keypadSplit=document.getElementById('keypadSplit');
    const backFromSplit=document.getElementById('backFromSplit');

    const totalTimeEl=document.getElementById('totalTime');
    const correctCountEl=document.getElementById('correctCount');
    const avgTimeEl=document.getElementById('avgTime');
    const mistakesEl=document.getElementById('mistakes');

    const rankingTitle=document.getElementById('rankingTitle');
    const rankingList=document.getElementById('rankingList');
    const rankInfo=document.getElementById('rankInfo');
    const restartBtn=document.getElementById('restartBtn');

    const soundCorrect=document.getElementById('soundCorrect');
    const soundWrong=document.getElementById('soundWrong');

    let state={};

    function randInt(min,max){return Math.floor(Math.random()*(max-min+1))+min}
    function formatMs(ms){return (ms/1000).toFixed(2)+'ì´ˆ'}

    // ---------- ë§ì…ˆ ê²Œì„ ----------
    function newAdditionProblem(){
      // ì •ë‹µ 1~20 ë³´ì¥ (0 ì œê±°)
      for(let i=0;i<100;i++){
        const a=randInt(0,10), b=randInt(0,10);
        const s=a+b;
        if(s>=1 && s<=20) return {a,b};
      }
      return {a:1,b:1};
    }
    function buildKeypadAdd(){
      keypadAdd.innerHTML='';
      for(let i=1;i<=20;i++){
        const btn=document.createElement('button');
        btn.type='button';
        btn.textContent=i;
        btn.addEventListener('click',()=>submitAddition(i));
        keypadAdd.appendChild(btn);
      }
    }
    function startAddition(){
      state={mode:'addition',total:5,index:0,startTime:performance.now(),mistakes:0};
      results.hidden=true;startScreen.hidden=true;additionScreen.hidden=false;splitScreen.hidden=true;
      nextAddition();tick(timerAdd);
    }
    function nextAddition(){
      state.current=newAdditionProblem();
      qNumberAdd.textContent=`${state.index+1}ë²ˆ ë¬¸ì œ`;
      problemBoxAdd.textContent=`${state.current.a} + ${state.current.b} = ?`;
      feedbackAdd.textContent='';
      buildKeypadAdd();
    }
    function submitAddition(ans){
      if(ans===(state.current.a+state.current.b)){
        soundCorrect.play();
        state.index++;
        if(state.index>=state.total){finish()}else{nextAddition()}
      }else{
        soundWrong.play();
        feedbackAdd.textContent='ì˜¤ë‹µ! ë‹¤ì‹œ ì‹œë„';feedbackAdd.className='feedback bad';
        state.mistakes++;
      }
    }

    // ---------- ëª¨ìœ¼ê¸°/ê°€ë¥´ê¸° ê²Œì„ (ê°€ë³€ ê¸°ì¤€ p) ----------
    function newSplitProblem(){
      for(let tries=0; tries<200; tries++){
        const isAdd = Math.random()<0.5;
        if(isAdd){
          const a = randInt(2,19);                 // 2..19
          const b = randInt(1,20-a);               // 1..(20-a) â†’ a+b â‰¤ 20
          const p = randInt(1,a-1);                // 1..a-1
          const s1 = a - p;                         // â‰¥1
          const s2 = s1 + b;                        // â‰¤ 20
          const s3 = a + b;                         // â‰¤20
          if(s1>=1 && s1<=20 && s2>=1 && s2<=20 && s3<=20){
            return {type:'add',a:a,b:b,p:p,solution:[s1,s2,s3]};
          }
        }else{
          const a = randInt(3,20);                 // ìµœì†Œ 3
          const r = randInt(1, Math.min(10, a-2)); // ìµœì¢…ê²°ê³¼ 1..10
          const b = a - r;                          // 1..19
          const pMin = r + 1;                       // p > a-b(=r)
          const pMax = a - 1;
          if(pMin<=pMax){
            const p = randInt(pMin, pMax);
            const s1 = a - p;                       // â‰¥1
            const s2 = b - s1;                      // = p - r â‰¥1
            const s3 = r;                           // 1..10
            if(s1>=1 && s1<=20 && s2>=1 && s2<=20 && s3>=1 && s3<=10){
              return {type:'sub',a:a,b:b,p:p,solution:[s1,s2,s3]};
            }
          }
        }
      }
      return {type:'add',a:11,b:1,p:10,solution:[1,2,12]};
    }

    function buildKeypadSplit(){
      keypadSplit.innerHTML='';
      for(let i=1;i<=20;i++){
        const btn=document.createElement('button');
        btn.type='button';
        btn.textContent=i;
        btn.addEventListener('click',()=>submitSplitStep(i));
        keypadSplit.appendChild(btn);
      }
    }
    function startSplit(){
      state={mode:'split',total:3,index:0,startTime:performance.now(),mistakes:0,focus:0,answers:[null,null,null]};
      results.hidden=true;startScreen.hidden=true;additionScreen.hidden=true;splitScreen.hidden=false;
      nextSplit();tick(timerSplit);
    }
    function nextSplit(){
      state.current=newSplitProblem();
      state.focus=0;state.answers=[null,null,null];
      qNumberSplit.textContent=`${state.index+1}ë²ˆ ë¬¸ì œ`;
      renderSplitProblem();
      feedbackSplit.textContent='';
      buildKeypadSplit();
    }
    function renderSplitProblem(){
      const {type,a,b,p} = state.current;
      if(type==='add'){
        problemBoxSplit.innerHTML = `
          <div style="font-size:28px;margin:8px 0">${a} + ${b}</div>
          <div style="font-size:28px;margin:8px 0">= ${p} + <span class="blank ${state.focus===0?'active':''}">${state.answers[0]??''}</span> + ${b}</div>
          <div style="font-size:28px;margin:8px 0">= ${p} + <span class="blank ${state.focus===1?'active':''}">${state.answers[1]??''}</span> = <span class="blank ${state.focus===2?'active':''}">${state.answers[2]??''}</span></div>
        `;
      }else{
        problemBoxSplit.innerHTML = `
          <div style="font-size:28px;margin:8px 0">${a} - ${b}</div>
          <div style="font-size:28px;margin:8px 0">= ${p} + <span class="blank ${state.focus===0?'active':''}">${state.answers[0]??''}</span> - ${b}</div>
          <div style="font-size:28px;margin:8px 0">= ${p} - <span class="blank ${state.focus===1?'active':''}">${state.answers[1]??''}</span> = <span class="blank ${state.focus===2?'active':''}">${state.answers[2]??''}</span></div>
        `;
      }
    }
    function submitSplitStep(val){
      const idx=state.focus;
      const target = state.current.solution[idx];
      if(val===target){
        soundCorrect.play();
        state.answers[idx]=val;
        state.focus++;
        if(state.focus>=3){
          state.index++;
          if(state.index>=state.total){finish()}else{nextSplit()}
        }else{
          renderSplitProblem();
        }
      }else{
        soundWrong.play();
        feedbackSplit.textContent='ì˜¤ë‹µ! ë‹¤ì‹œ ì‹œë„';feedbackSplit.className='feedback bad';
        state.mistakes++;
        state.answers=[null,null,null];
        state.focus=0;
        renderSplitProblem();
      }
    }

    // ---------- ê³µí†µ ----------
    function tick(timerEl){
      function step(){
        const ms=performance.now()-state.startTime;
        timerEl.textContent=(ms/1000).toFixed(2)+'ì´ˆ';
        state.timerId=requestAnimationFrame(step);
      }
      cancelAnimationFrame(state.timerId);
      state.timerId=requestAnimationFrame(step);
    }

    // ëª¨ë“œë³„ ë­í‚¹ ì €ì¥/í‘œì‹œ (ë¶„ë¦¬ ì €ì¥)
    function saveRanking(totalMs){
      const name=getPlayerName();
      const record={name,score:state.total,time:totalMs,mode:state.mode};
      const key = state.mode==='addition' ? 'ranking_addition' : 'ranking_split';
      let ranking=JSON.parse(localStorage.getItem(key)||'[]');
      ranking.push(record);
      ranking.sort((a,b)=> b.score-a.score || a.time-b.time);
      ranking=ranking.slice(0,20);
      localStorage.setItem(key,JSON.stringify(ranking));
      renderRanking(ranking,record);
      rankingTitle.textContent = state.mode==='addition' ? 'ğŸ† ìˆœìœ„í‘œ (ë§ì…ˆ) ğŸ†' : 'ğŸ† ìˆœìœ„í‘œ (ëª¨ìœ¼ê¸°/ê°€ë¥´ê¸°) ğŸ†';
    }

    function renderRanking(ranking,record){
      rankingList.innerHTML='';
      let myRank=null;
      ranking.forEach((r,i)=>{
        const li=document.createElement('li');
        let medal='';
        if(i===0) medal='ğŸ¥‡ ';
        else if(i===1) medal='ğŸ¥ˆ ';
        else if(i===2) medal='ğŸ¥‰ ';
        else medal='â­ ';
        li.textContent=`${medal}${i+1}ìœ„: ${r.name} (ì ìˆ˜:${r.score}, ì‹œê°„:${(r.time/1000).toFixed(2)}ì´ˆ)`;
        rankingList.appendChild(li);
        if(r===record) myRank=i+1;
      });
      rankInfo.textContent=myRank?`í˜„ì¬ ê¸°ë¡ì€ ${myRank}ìœ„ ì…ë‹ˆë‹¤.`:'';
    }

    function finish(){
      cancelAnimationFrame(state.timerId);
      const totalMs=performance.now()-state.startTime;
      totalTimeEl.textContent=formatMs(totalMs);
      correctCountEl.textContent=state.total;
      avgTimeEl.textContent=(totalMs/1000/state.total).toFixed(2)+'ì´ˆ';
      mistakesEl.textContent=state.mistakes;
      additionScreen.hidden=true;splitScreen.hidden=true;results.hidden=false;
      saveRanking(totalMs);
    }

    // --- ì´ë²¤íŠ¸ ë°”ì¸ë”© ---
    additionSelect.addEventListener('click',startAddition);
    splitSelect.addEventListener('click',startSplit);
    backFromAdd.addEventListener('click',()=>{additionScreen.hidden=true;startScreen.hidden=false});
    backFromSplit.addEventListener('click',()=>{splitScreen.hidden=true;startScreen.hidden=false});
    restartBtn.addEventListener('click',()=>{results.hidden=true;startScreen.hidden=false});
  });
  </script>
</body>
</html>
